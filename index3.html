<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (Saving 1: S4 Excluded)</title>
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; padding: 20px; text-align: center; background-color: #f4f7f6; }
        .container-box { max-width: 700px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        h1 { font-size: 32px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 24px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        button { margin: 10px 5px; padding: 12px 24px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; transition: background-color 0.3s; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }
        .form-control { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; max-width: 400px; margin-top: 5px; text-align: center; font-size: 16px; }
        .difficulty-option { display: inline-block; margin: 8px; cursor: pointer; padding: 10px 20px; border: 2px solid #ccc; border-radius: 20px; }
        input[type="radio"]:checked + .difficulty-option { background-color: #337ab7; color: white; border-color: #337ab7; font-weight: bold; }
        input[type="radio"] { display: none; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status"></div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£...</h5>
        <div class="progress"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (Saving 1)</h1>
        
        <div id="registrationSection">
            <h2>üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</h2>
            <div style="margin-bottom: 20px;">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="text" class="form-control" id="inputUserName" required>
            </div>
            <div style="margin-bottom: 20px;">
                <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                <input type="text" class="form-control" id="inputUserGroup" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å">
            </div>
            <div style="margin-bottom: 30px;">
                <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label><br>
                <input type="radio" id="diffEasy" name="difficulty" value="easy" checked><label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                <input type="radio" id="diffHard" name="difficulty" value="hard"><label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>
                <input type="radio" id="diffHarder" name="difficulty" value="harder"><label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
            </div>
            <button id="startTestBtn" style="background-color: #28a745; color: white;">‚ñ∂Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>
        
        <div id="testSection" style="display: none;">
            <h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <p>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏£‡∏ß‡∏°: <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span> | Q: <span id="qRound">1</span>/<span id="maxQSpan">10</span> | C: <span id="cRound">1</span>/<span id="maxCSpan">5</span> | A: <span id="aRound">1</span>/<span id="maxASpan">7</span></p>

            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (T<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio"></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</button>
                <p id="s1StatusElement">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Pitch)</h2>
                <button id="pitchRecordBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Q<span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°)</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≠‡∏ö <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button id="closeBtn">üéôÔ∏è 1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</button> 
                <p id="s3StatusElement">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            
            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Step <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                <div id="registrationStepsDisplay" style="text-align: left; padding: 15px; background:#f8f9fa;">
                    <ol id="stepList"></ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
            </div>
            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1><h2 id="traineeName"></h2>
                <p>‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- 1. Supabase Config & Global State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // FIX: Product Tag Configuration
        const DEFAULT_PRODUCT_TAG = 'saving1'; 
        const CURRENT_PRODUCT_TAG = localStorage.getItem('roleplaySelectedProductTag') || DEFAULT_PRODUCT_TAG;
        const FILTER_TAGS = [CURRENT_PRODUCT_TAG]; 

        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
        let productDisplayName = 'Saving 1 (No S4)'; 

        // Variables (S4 Excluded)
        let allRecordings = [], mediaRecorder = null, currentUserId = null, audioChunks = [];
        let turn=0, qRound=0, cRound=0, aRound=0; 
        let maxTurns, maxQ, maxC, maxA; 
        let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS5Steps=[]; 
        let audioCache={}, selectedRandomFiles=[], lastCustomerAudioUrl='N/A';
        let selectedS2Files = [], selectedS3Files = []; 

        // --- 2. Helper Functions (Required for operation) ---
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            let newArray = [...array]; 
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [newArray[currentIndex], newArray[randomIndex]] = [newArray[randomIndex], newArray[currentIndex]];
            }
            return newArray;
        }

        const playAudio = (url, statusEl, onEnd) => {
            const audio = window.customerAudio.id === statusEl.id ? window.customerAudio : 
                          window.questionAudio.id === statusEl.id ? window.questionAudio :
                          window.objectionAudio.id === statusEl.id ? window.objectionAudio : 
                          window.agreementAudio;

            audio.src = url;
            statusEl.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            audio.play().then(() => {
                statusEl.textContent = "üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
            }).catch(e => { statusEl.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ: " + e.message; });
            audio.onended = onEnd;
        };

        const hideAll = () => ['section1Div','section1_5Div','section2Div','section3Div','section5Div'].forEach(id=>document.getElementById(id).style.display='none');

        const updateStepHighlight = function(currentStep) {
            Array.from(window.stepList.children).forEach((li, index) => {
                li.style.fontWeight = (index + 1) === currentStep ? 'bold' : 'normal';
                li.style.color = (index + 1) === currentStep ? '#d9534f' : '#333';
            });
        };
        
        const renderRegistrationSteps = function() {
            window.stepList.innerHTML = ''; 
            globalS5Steps.forEach((s, i) => {
                const li = document.createElement('li');
                li.id = `reg-step-${i + 1}`;
                li.textContent = s.step_name;
                window.stepList.appendChild(li);
            });
        }
        
        const generateCertificate = function() {
            window.traineeName.textContent = window.inputUserName.value;
            window.issueDate.textContent = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        const storeRecording = (audioBlob, part, qNum, qText, customerAudioUrl = 'N/A') => {
            const fileName = `${currentUserId}_${part}_${qNum}_${Date.now()}.webm`;
            allRecordings.push({
                blob: audioBlob,
                name: fileName,
                part: part,
                qNum: qNum,
                qText: qText,
                customerAudioUrl: customerAudioUrl,
                difficulty: document.querySelector('input[name="difficulty"]:checked').value
            });
        };

        const uploadAllRecordings = async () => {
            const total = allRecordings.length;
            let uploaded = 0;
            window.loadingOverlay.style.display = "flex";
            window.finalSaveBtn.disabled = true;

            try {
                for (const record of allRecordings) {
                    window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${uploaded + 1}/${total}...`;
                    const path = `responses/${CURRENT_PRODUCT_TAG}/${record.name}`;
                    
                    const { error: uploadError } = await window.supabase.storage
                        .from('responses')
                        .upload(path, record.blob, { contentType: 'audio/webm' });
                    
                    if (uploadError) throw uploadError;

                    // Get public URL
                    const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(path);

                    // Insert metadata to 'test_results' table
                    const { error: insertError } = await window.supabase
                        .from('test_results')
                        .insert([
                            {
                                user_id: currentUserId,
                                full_name: window.inputUserName.value,
                                user_group: window.inputUserGroup.value,
                                product_tag: CURRENT_PRODUCT_TAG,
                                difficulty: record.difficulty,
                                part: record.part,
                                q_index: record.qNum,
                                q_text: record.qText,
                                recording_url: publicUrl,
                                customer_audio_url: record.customerAudioUrl
                            }
                        ]);
                    
                    if (insertError) throw insertError;
                    
                    uploaded++;
                    window.uploadProgressBar.style.width = `${(uploaded / total) * 100}%`;
                }
                
                window.loadingText.textContent = "üéâ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!";
                window.finalSaveBtn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                window.finalSaveBtn.classList.add('done');
                setTimeout(() => { window.loadingOverlay.style.display = "none"; }, 1500);
                generateCertificate();
                window.certBtn.style.display = 'block';

            } catch (error) {
                console.error("Upload/Save Error:", error);
                window.loadingText.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`;
                setTimeout(() => { 
                    window.loadingOverlay.style.display = "none"; 
                    window.finalSaveBtn.disabled = false;
                }, 3000);
            }
        };

        const saveAllRecordings = () => {
            uploadAllRecordings();
        };


        // --- 3. Flow Control Functions (Adjusted for S4 Exclusion) ---
        
        const toggleRecording = async (partId, buttonElement) => {
            const statusEl = buttonElement === window.recordBtn ? window.s1StatusElement :
                             buttonElement === window.pitchRecordBtn ? window.pitchStatus :
                             buttonElement === window.answerBtn ? window.qStatus :
                             buttonElement === window.closeBtn ? window.s3StatusElement :
                             buttonElement === window.replyBtn ? window.s3StatusElement :
                             window.aStatus;

            if (!mediaRecorder) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        // 1: S1, 2: S1.5 (Pitch), 3: S2 (Answer Q), 4: S3 (Close), 5: S3 (Reply Objection), 6: S5 (Agreement)
                        let qText = 'N/A', partTag = '';
                        let qNum = 0;
                        
                        if (partId === 1) { 
                            qText = `S1 Turn ${turn}`; partTag = 'S1'; qNum = turn;
                            window.nextRoundBtn.disabled = false;
                        } else if (partId === 2) { 
                            qText = `S1.5 Pitch`; partTag = 'S1.5'; qNum = 1;
                            window.nextSection2Btn.disabled = false;
                        } else if (partId === 3) { 
                            const currentQ = selectedS2Files[qRound - 1];
                            qText = `S2 Question ${qRound}`; partTag = 'S2'; qNum = currentQ.q_index;
                            window.nextSection3Btn.disabled = false;
                        } else if (partId === 4) { 
                            qText = `S3 Close Round ${cRound}`; partTag = 'S3_C'; qNum = cRound;
                            window.replyBtn.disabled = false; // Next is replying to objection
                        } else if (partId === 5) { 
                            const currentObjection = selectedS3Files[cRound - 1];
                            qText = `S3 Reply Objection ${cRound}`; partTag = 'S3_R'; qNum = currentObjection.ob_index;
                            startNextCloseRoundAuto(); // Check if maxC reached
                        } else if (partId === 6) {
                            const currentStep = globalS5Steps[aRound - 1];
                            qText = `S5 Step ${aRound}: ${currentStep.step_name}`; partTag = 'S5'; qNum = currentStep.step_index;
                            playCustomerReplyAndSetupNextStep(); 
                        }

                        storeRecording(audioBlob, partTag, qNum, qText, lastCustomerAudioUrl);

                        buttonElement.disabled = false;
                        buttonElement.textContent = buttonElement.originalText;
                        statusEl.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (${Math.round(audioBlob.size/1024)} KB)`;
                        mediaRecorder = null;
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    buttonElement.originalText = buttonElement.textContent;
                    buttonElement.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏´‡∏¢‡∏∏‡∏î)';
                    buttonElement.disabled = false; 
                    statusEl.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...';
                    
                    // Disable other buttons during recording
                    if (partId === 1) { window.nextRoundBtn.disabled = true; }
                    if (partId === 3) { window.nextSection3Btn.disabled = true; }
                    if (partId === 4) { window.replyBtn.disabled = true; } 
                    if (partId === 6) { window.answerABtn.disabled = false; } // S5: Enable self to stop

                } catch (error) {
                    console.error("Error accessing microphone:", error);
                    statusEl.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: " + error.message;
                    mediaRecorder = null;
                }
            } else {
                mediaRecorder.stop();
            }
        };

        const nextTurn = () => {
            turn++;
            if (turn <= maxTurns) {
                document.getElementById('turnSpan').textContent = turn;
                prepareTurnFiles();
                window.recordBtn.disabled = false;
                window.nextRoundBtn.disabled = true;
                window.s1StatusElement.textContent = `üîä ‡∏ü‡∏±‡∏á‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn}/${maxTurns})`;
            } else {
                initSection1_5();
            }
        };

        const prepareTurnFiles = function() {
            const turnFile = globalS1Files.find(f => f.turn_index === turn);
            if (turnFile) {
                lastCustomerAudioUrl = turnFile.audio_url;
                playAudio(turnFile.audio_url, window.s1StatusElement, () => {
                    window.recordBtn.disabled = false;
                    window.s1StatusElement.textContent = `üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn}/${maxTurns})`;
                });
            } else {
                // If no file, allow agent to speak first (e.g., initial greeting)
                window.recordBtn.disabled = false;
                window.s1StatusElement.textContent = `üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn}/${maxTurns})`;
            }
        };

        const initSection1_5 = function() {
            hideAll();
            document.getElementById('section1_5Div').style.display = 'block';
            window.pitchRecordBtn.disabled = false;
            window.nextSection2Btn.disabled = true;
            window.pitchStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Pitch)";
        };
        
        const initSection2 = function() {
            hideAll();
            document.getElementById('section2Div').style.display = 'block';
            window.startQBtn.disabled = false;
            window.answerBtn.disabled = true;
            window.nextSection3Btn.disabled = true;
            qRound = 0; // Reset question round
            
            // Randomly select files for S2
            const maxQIndex = Math.min(maxQ, globalS2Files.length);
            selectedS2Files = shuffleArray(globalS2Files).slice(0, maxQIndex);
            
            window.qStatus.textContent = `‡∏Å‡∏î '‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/${maxQIndex}`;
            window.maxQSpan.textContent = maxQIndex;
            window.qRound.textContent = qRound + 1; // Prepare for first round
        };

        const playSequentialQuestion = function() {
            if (qRound >= selectedS2Files.length) {
                window.qStatus.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3";
                window.startQBtn.disabled = true;
                window.nextSection3Btn.disabled = false;
                return;
            }
            
            const currentQ = selectedS2Files[qRound];
            lastCustomerAudioUrl = currentQ.audio_url;
            window.startQBtn.disabled = true; // Disable until answer is recorded
            
            playAudio(currentQ.audio_url, window.qStatus, () => {
                window.answerBtn.disabled = false;
                window.qStatus.textContent = `üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${qRound + 1}`;
            });
            
            qRound++;
            window.qRound.textContent = qRound;
            window.answerBtn.onclick = () => toggleRecording(3, window.answerBtn);
        };
        
        const initSection3 = function() {
            hideAll(); 
            document.getElementById('section3Div').style.display = 'block';
            window.closeBtn.disabled = false; 
            window.replyBtn.disabled = true;
            window.nextSection5Btn.disabled = true; // FIX: ‡πÉ‡∏ä‡πâ nextSection5Btn
            cRound = 0;
            window.closeBtn.style.display = 'block'; 
            
            // Randomly select files for S3
            const maxCIndex = Math.min(maxC, globalS3Files.length);
            selectedS3Files = shuffleArray(globalS3Files).slice(0, maxCIndex);
            window.maxCSpan.textContent = maxCIndex;
            window.cRound.textContent = cRound + 1; 

            lastCustomerAudioUrl = 'S3 Initial Closing (No Customer Audio)'; 
            window.s3StatusElement.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
        };

        const playSequentialObjectionAuto = function() {
            cRound++;
            window.cRound.textContent = cRound;
            
            if (cRound > selectedS3Files.length) {
                 window.s3StatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3! ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
                 window.replyBtn.disabled = true;
                 window.closeBtn.style.display = 'none'; 
                 window.nextSection5Btn.disabled = false; // FIX: ‡πÉ‡∏ä‡πâ nextSection5Btn
                 return;
            }

            const currentObjection = selectedS3Files[cRound - 1];
            lastCustomerAudioUrl = currentObjection.audio_url;
            window.closeBtn.disabled = true;
            window.replyBtn.disabled = true;
            
            playAudio(currentObjection.audio_url, window.s3StatusElement, () => {
                window.replyBtn.disabled = false;
                window.s3StatusElement.textContent = `üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏ó‡∏µ‡πà ${cRound}/${selectedS3Files.length}`;
            });
        };

        const startNextCloseRoundAuto = function() {
             if (cRound < selectedS3Files.length) {
                window.closeBtn.disabled = false;
                window.replyBtn.disabled = true;
                window.s3StatusElement.textContent = `‚úÖ ‡∏ï‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${cRound + 1}/${selectedS3Files.length})`;
            } else {
                window.s3StatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5";
                window.replyBtn.disabled = true;
                window.closeBtn.style.display = 'none';
                window.nextSection5Btn.disabled = false; // FIX: ‡πÉ‡∏ä‡πâ nextSection5Btn
            }
        };

        // ‚ö†Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î S4 ‡∏ñ‡∏π‡∏Å‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
        
        const initSection5 = function() {
            hideAll();
            document.getElementById('section5Div').style.display = 'block';
            window.answerABtn.disabled = false;
            window.finalSaveBtn.disabled = true;
            aRound = 0;
            
            window.maxASpan.textContent = globalS5Steps.length;
            renderRegistrationSteps(); // Render steps list
            playCustomerReplyAndSetupNextStep(); 
        };

        const playCustomerReplyAndSetupNextStep = function() {
            aRound++;
            updateStepHighlight(aRound);
            window.aRound.textContent = aRound;

            if (aRound > globalS5Steps.length) {
                window.aStatus.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'";
                window.answerABtn.disabled = true;
                window.finalSaveBtn.disabled = false;
                return;
            }
            
            const currentStep = globalS5Steps[aRound - 1];
            lastCustomerAudioUrl = currentStep.customer_audio_url;
            window.answerABtn.disabled = true;
            
            // Play customer agreement audio
            playAudio(currentStep.customer_audio_url, window.aStatus, () => {
                window.answerABtn.disabled = false;
                window.aStatus.textContent = `üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${aRound}/${globalS5Steps.length}: ${currentStep.step_name}`;
            });
        };


        // --- 4. Initialization and DOM Assignment ---
        const initializeUserAndDOM = async function() {
            
            // A. Assign DOM Elements to window for easy access
            window.inputUserName = document.getElementById('inputUserName');
            window.inputUserGroup = document.getElementById('inputUserGroup');
            window.registrationSection = document.getElementById('registrationSection');
            window.testSection = document.getElementById('testSection');
            window.startTestBtn = document.getElementById('startTestBtn');
            window.loadingOverlay = document.getElementById('loadingOverlay');
            window.loadingText = document.getElementById('loadingText');
            window.uploadProgressBar = document.getElementById('uploadProgressBar');
            window.customerAudio = document.getElementById('customerAudio');
            window.questionAudio = document.getElementById('questionAudio');
            window.objectionAudio = document.getElementById('objectionAudio');
            window.agreementAudio = document.getElementById('agreementAudio');
            window.s1StatusElement = document.getElementById('s1StatusElement'); // S1 Status
            window.pitchStatus = document.getElementById('pitchStatus');
            window.qStatus = document.getElementById('qStatus');
            window.s3StatusElement = document.getElementById('s3StatusElement'); // S3 Status
            window.aStatus = document.getElementById('aStatus'); // S5 Status
            window.recordBtn = document.getElementById('recordBtn');
            window.nextRoundBtn = document.getElementById('nextRoundBtn');
            window.pitchRecordBtn = document.getElementById('pitchRecordBtn');
            window.nextSection2Btn = document.getElementById('nextSection2Btn');
            window.startQBtn = document.getElementById('startQBtn');
            window.answerBtn = document.getElementById('answerBtn');
            window.nextSection3Btn = document.getElementById('nextSection3Btn');
            window.closeBtn = document.getElementById('closeBtn');
            window.replyBtn = document.getElementById('replyBtn');
            window.nextSection5Btn = document.getElementById('nextSection5Btn'); // FIX: nextSection5Btn
            window.answerABtn = document.getElementById('answerABtn');
            window.finalSaveBtn = document.getElementById('finalSaveBtn');
            window.certBtn = document.getElementById('certBtn');
            window.traineeName = document.getElementById('traineeName');
            window.issueDate = document.getElementById('issueDate');
            window.stepList = document.getElementById('stepList');

            window.turnSpan = document.getElementById('turnSpan');
            window.maxTurnSpan = document.getElementById('maxTurnSpan');
            window.qRound = document.getElementById('qRound');
            window.maxQSpan = document.getElementById('maxQSpan');
            window.cRound = document.getElementById('cRound');
            window.maxCSpan = document.getElementById('maxCSpan');
            window.aRound = document.getElementById('aRound');
            window.maxASpan = document.getElementById('maxASpan');
            
            // B. Bind Event Listeners
            // FIX: ‡πÉ‡∏ä‡πâ Arrow function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á mediaRecorder ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            window.recordBtn.onclick = () => toggleRecording(1, window.recordBtn);
            window.nextRoundBtn.onclick = nextTurn;
            window.pitchRecordBtn.onclick = () => toggleRecording(2, window.pitchRecordBtn);
            window.nextSection2Btn.onclick = initSection2;
            window.startQBtn.onclick = playSequentialQuestion;
            window.nextSection3Btn.onclick = initSection3;
            window.closeBtn.onclick = () => toggleRecording(4, window.closeBtn);
            window.replyBtn.onclick = playSequentialObjectionAuto; // S3 reply is recorded in playSequentialObjectionAuto
            window.nextSection5Btn.onclick = initSection5; // FIX: Flow S3 -> S5
            window.answerABtn.onclick = () => toggleRecording(6, window.answerABtn);
            window.finalSaveBtn.onclick = saveAllRecordings;
            window.certBtn.onclick = generateCertificate;


            // C. Main Start Function Definition (Called by the button)
            const startTest = async () => {
                const fullName = window.inputUserName.value.trim();
                const userGroup = window.inputUserGroup.value.trim();
                
                if (!fullName || !userGroup) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                    return;
                }
                
                // Get selected difficulty
                const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
                const config = globalConfig[selectedDifficulty];
                
                if (!config) {
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å "${selectedDifficulty}" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
                    return;
                }

                // Set max values
                maxTurns = config.S1;
                maxQ = config.S2;
                maxC = config.S3;
                maxA = config.S5; 

                // Update UI max values
                window.maxTurnSpan.textContent = maxTurns;
                window.maxQSpan.textContent = maxQ;
                window.maxCSpan.textContent = maxC;
                window.maxASpan.textContent = maxA; 
                
                // Set current user ID
                currentUserId = uuidv4();
                
                // Transition to test section
                window.registrationSection.style.display = 'none';
                window.testSection.style.display = 'block';

                // Start Section 1
                hideAll();
                document.getElementById('section1Div').style.display = 'block';
                turn = 1; // Start at Turn 1
                window.turnSpan.textContent = turn;

                prepareTurnFiles(); 
                window.nextRoundBtn.disabled = true;
                window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;

                // Enable the main recording button (will be disabled by prepareTurnFiles if an audio file exists for turn 1)
                window.recordBtn.disabled = false;
            };

            // D. Set Start Button Listener
            window.startTestBtn.onclick = startTest;


            // E. Auto Fill Logic (FIXED)
            const storedUserData = localStorage.getItem('roleplayUserData');

            if(await fetchInitialData()) {
                document.querySelector('h1').textContent = `E-Simulator Roleplay (${productDisplayName})`;
                if (storedUserData) {
                    try {
                        const userData = JSON.parse(storedUserData);
                        window.inputUserName.value = userData.fullName || '';
                        window.inputUserGroup.value = userData.department || '';
                        
                        // Check if a saved difficulty exists
                        const storedDiff = localStorage.getItem('roleplayDifficulty');
                        if(storedDiff) {
                            const diffRadio = document.querySelector(`input[name="difficulty"][value="${storedDiff}"]`);
                            if(diffRadio) diffRadio.checked = true;
                        }
                    } catch (e) {
                        console.error("Error parsing user data from localStorage:", e);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
    </script>
</body>
</html>
