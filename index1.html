<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (Multi-Product Support)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { 
            font-size: 28px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 22px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button { 
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 16px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }

        .form-control {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
        }

        /* Radio Buttons */
        .difficulty-option {
            display: inline-block;
            margin: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .difficulty-option:hover { border-color: #337ab7; }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7;
            color: white;
            border-color: #337ab7;
            font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000; text-align: center; font-size: 20px;
        }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }

        @media (max-width: 600px) {
            .container-box { padding: 15px; margin: 0 10px; }
            h1 { font-size: 24px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status"></div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h5>
        <div class="progress"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay System</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="text" class="form-control" id="inputUserName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                <select class="form-control" id="inputUserGroup" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                    <option value="Nursery">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà (Nursery)</option>
                    <option value="NewTSRsOnboarding">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs Onboarding</option>
                    <option value="NewTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs</option>
                    <option value="ExistingTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° Existing TSRs</option>
                </select>
            </div>

            <div style="margin-bottom: 20px; background-color: #eaf4ff; padding: 15px; border-radius: 8px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px; color: #0056b3;">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Product Line):</label>
                <select class="form-control" id="inputProductType" required style="border: 2px solid #007bff;">
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå --</option>
                    <option value="health">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health)</option>
                    <option value="life">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Life)</option>
                    <option value="retirement">‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏ (Retirement)</option>
                    <option value="saving">‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (Saving)</option>
                    </select>
            </div>

            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="easy" checked>
                    <label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                    <input type="radio" id="diffHard" name="difficulty" value="hard">
                    <label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>
                    <input type="radio" id="diffHarder" name="difficulty" value="harder">
                    <label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
                </div>
            </div>
            
            <button id="startTestBtn" style="background-color: #28a745; color: white;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>
        
        <div id="testSection" style="display: none;">
            
            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (T<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio" src=""></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5)</button>
                <p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Q<span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3)</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (Round <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>)</h2>
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; border-radius: 8px; background-color: #ffeaea; font-weight: bold; font-size: 18px; color: #333;"></div>
                <audio id="healthAudio"></audio>
                <button disabled id="answerHBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
                <p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Step <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                <div id="registrationStepsDisplay" style="text-align: left; margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <h4 style="color: #333; margin-top: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°:</h4>
                    <ol id="stepList" style="padding-left: 20px; font-size: 16px;"></ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</p>
                <hr>
            </div>

            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
                <h2 id="traineeName">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
                <p>‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Roleplay ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</p>
                <h3 id="certProduct">[Product Name]</h3>
                <p style="margin-top: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠....................................................</p>
                <p>(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°)</p>
                <p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- 1. Supabase Config ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // --- 2. Global State Variables ---
        let mediaRecorder = null;
        let currentUserId = localStorage.getItem('roleplay_user_id') || uuidv4();
        localStorage.setItem('roleplay_user_id', currentUserId);
        
        let allRecordings = []; 
        let lastCustomerAudioUrl = 'N/A';
        // --- ‡πÅ‡∏ó‡∏£‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ undefined ---
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ JS ‡∏Å‡∏±‡∏ö ID ‡πÉ‡∏ô HTML
        const initDOM = function() {
            // ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà Status Text
            window.s1StatusElement = document.getElementById('status');
            window.s2StatusElement = document.getElementById('qStatus');
            window.s3StatusElement = document.getElementById('cStatus');
            window.hStatusElement = document.getElementById('hStatus');
            window.aStatusElement = document.getElementById('aStatus');
            window.pitchStatusElement = document.getElementById('pitchStatus');

            // ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Counters
            window.turnSpan = document.getElementById('turnSpan');
            window.maxTurnSpan = document.getElementById('maxTurnSpan');
            window.qRoundSpan = document.getElementById('qRound');
            window.maxQSpan = document.getElementById('maxQSpan');
            window.cRoundSpan = document.getElementById('cRound');
            window.maxCSpan = document.getElementById('maxCSpan');
            window.hQName = document.getElementById('hQName');
            window.aRoundSpan = document.getElementById('aRound');
            window.maxASpan = document.getElementById('maxASpan');

            // ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏õ‡∏∏‡πà‡∏°
            window.recordBtn = document.getElementById('recordBtn');
            window.pitchRecordBtn = document.getElementById('pitchRecordBtn');
            window.answerBtn = document.getElementById('answerBtn');
            window.closeBtn = document.getElementById('closeBtn');
            window.replyBtn = document.getElementById('replyBtn');
            window.answerHBtn = document.getElementById('answerHBtn');
            window.answerABtn = document.getElementById('answerABtn');
            
            // ‡∏õ‡∏∏‡πà‡∏° Next (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
            window.nextRoundBtn = document.getElementById('nextRoundBtn');
            window.nextSection2Btn = document.getElementById('nextSection2Btn');
            window.nextSection3Btn = document.getElementById('nextSection3Btn');
            window.nextSection4Btn = document.getElementById('nextSection4Btn');
            window.nextSection5Btn = document.getElementById('nextSection5Btn');
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
        initDOM();
        
        // --------------------------------------------------
        // Counters
        let turn = 0, qRound = 0, cRound = 0, currentHIndex = 0, aRound = 0;
        let isFollowUpMode = false, followUpStep = 0;
        let selectedDisease = null;

        // Max Limits (Load from DB)
        let maxTurns, maxQ, maxC, maxH, maxA, maxFollowUp = 5;

        // --- 3. Data Storage (The "Stable" Architecture) ---
        
        // A. RAW DATA (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)
        let rawS1Data = [], rawS2Data = [], rawS3Data = [], rawS4Data = [], 
            rawS4FNames = [], rawS4FReplies = [], rawS5Data = [];
        let globalConfig = {};

        // B. FILTERED DATA (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏° Product ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô App)
        let globalS1Files = [];
        let globalS2Files = [];
        let globalS3Files = [];
        let globalS4Questions = [];
        let globalS4FollowUpNames = [];
        let globalS4FollowUpReplies = [];
        let globalS5Steps = [];

        // Utility: Audio Cache
        let audioCache = {};
        let selectedRandomFiles = [];
        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 

        // --- 4. Fetch All Data Logic (Stable Fetch) ---
        const fetchInitialData = async function() {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...`;

            try {
                // ‡∏î‡∏∂‡∏á Config
                const { data: configData } = await window.supabase.from('difficulty_config').select('*');
                if (configData) {
                    configData.forEach(c => {
                        globalConfig[c.difficulty_level] = {
                            S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5
                        };
                    });
                }

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1-S5 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà Supabase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Error 400)
                const p1 = window.supabase.from('customer_replies_s1').select('turn_index, audio_url, is_finale, product_type').order('turn_index');
                const p2 = window.supabase.from('questions_s2').select('q_index, audio_url, product_type').order('q_index');
                const p3 = window.supabase.from('objections_s3').select('ob_index, audio_url, product_type').order('ob_index');
                const p4 = window.supabase.from('health_questions_s4').select('q_index, q_text, is_yes_trigger, yes_trigger_url, product_type').order('q_index');
                const p4n = window.supabase.from('s4_follow_up_names').select('step_index, step_name, product_type').order('step_index');
                const p4r = window.supabase.from('s4_follow_up_replies').select('step_index, customer_audio_url, product_type').order('step_index');
                const p5 = window.supabase.from('scripts_s5').select('step_index, step_name, customer_audio_url, product_type').order('step_index');

                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const [r1, r2, r3, r4, r4n, r4r, r5] = await Promise.all([p1, p2, p3, p4, p4n, p4r, p5]);

                if(r1.error) throw r1.error;
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Raw Data
                rawS1Data = r1.data || [];
                rawS2Data = r2.data || [];
                rawS3Data = r3.data || [];
                rawS4Data = r4.data || [];
                rawS4FNames = r4n.data || [];
                rawS4FReplies = r4r.data || [];
                rawS5Data = r5.data || [];

                console.log("‚úÖ Data Fetched Successfully. S1 count:", rawS1Data.length);
                window.loadingText.textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`;
                
                setTimeout(() => { window.loadingOverlay.style.display = "none"; }, 500);
                return true;

            } catch (error) {
                console.error("Fetch Error:", error);
                window.loadingText.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                return false;
            }
        }

        // --- 5. Filtering Logic (Client-Side Filter) ---
        const filterByProduct = (dataArray, selectedType) => {
            if (!dataArray) return [];
            return dataArray.filter(row => {
                // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô DB ‡πÑ‡∏°‡πà‡∏°‡∏µ product_type ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Global ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà Logic)
                if (!row.product_type) return false; 
                
                // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Array ["health", "saving"]
                if (Array.isArray(row.product_type)) {
                    return row.product_type.includes(selectedType);
                }
                // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö String "health"
                return row.product_type === selectedType;
            });
        };

        const preloadCriticalAudio = function() {
            const urls = [
                ...globalS1Files.map(f => f.audio_url),
                ...globalS2Files.map(f => f.audio_url),
                ...globalS3Files.map(f => f.audio_url),
                ...globalS5Steps.map(f => f.customer_audio_url),
                (selectedDisease ? selectedDisease.yes_trigger_url : null),
                ...globalS4FollowUpReplies.map(f => f.customer_audio_url)
            ].filter(url => url && url.startsWith('http'));

            console.log(`Preloading ${urls.length} files for selected product...`);
            urls.forEach(url => {
                if (!audioCache[url]) {
                    const a = new Audio(url);
                    a.load();
                    audioCache[url] = a;
                }
            });
        }

        // --- 6. Start Test Logic ---
        const startTest = function() {
            const userName = window.inputUserName.value.trim();
            const userGroup = window.inputUserGroup.value;
            const selectedProductType = document.getElementById('inputProductType').value;
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;

            if (!userName || !userGroup || !selectedProductType) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏ä‡∏∑‡πà‡∏≠, ‡∏Å‡∏•‡∏∏‡πà‡∏°, ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå)");
                return;
            }
            
            // A. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Raw Data ‡πÄ‡∏Ç‡πâ‡∏≤ Global Data
            console.log(`Filtering for Product: ${selectedProductType}`);
            globalS1Files = filterByProduct(rawS1Data, selectedProductType);
            globalS2Files = filterByProduct(rawS2Data, selectedProductType);
            globalS3Files = filterByProduct(rawS3Data, selectedProductType);
            
            const s4Filtered = filterByProduct(rawS4Data, selectedProductType);
            globalS4Questions = s4Filtered.map(q => q.q_text);
            selectedDisease = s4Filtered.find(q => q.is_yes_trigger) || {}; // ‡∏´‡∏≤‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Trigger
            
            globalS4FollowUpNames = filterByProduct(rawS4FNames, selectedProductType);
            globalS4FollowUpReplies = filterByProduct(rawS4FReplies, selectedProductType);
            globalS5Steps = filterByProduct(rawS5Data, selectedProductType);

            // Validation
            if (globalS1Files.length === 0) {
                alert(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Product: ${selectedProductType}\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Database ‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå product_type ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°)`);
                // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            }

            // B. Setup Difficulty
            const config = globalConfig[selectedDifficulty] || { S1: 5, S2: 10, S3: 5, S4: 5, S5: 7 };
            maxTurns = config.S1; maxQ = config.S2; maxC = config.S3; maxH = config.S4; maxA = config.S5;
            
            // Update UI Counters
            window.maxTurnSpan.textContent = maxTurns;
            window.maxQSpan.textContent = maxQ;
            window.maxCSpan.textContent = maxC;
            window.maxASpan.textContent = maxA;

            // C. Preload & Prepare S1
            preloadCriticalAudio();
            prepareTurnFiles(selectedDifficulty);

            // D. Switch UI
            window.registrationSection.style.display = 'none';
            window.testSection.style.display = 'block';
            
            // Reset Displays
            ['section1Div', 'section1_5Div', 'section2Div', 'section3Div', 'section4Div', 'section5Div'].forEach(id => {
                document.getElementById(id).style.display = (id === 'section1Div') ? 'block' : 'none';
            });

            lastCustomerAudioUrl = 'S1 Initial Greeting (No Customer Audio)';
            window.recordBtn.disabled = false;
            window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
        }

        // --- 7. Core Logic Functions (S1-S5) ---
        
        const prepareTurnFiles = function(difficulty) {
            // Logic ‡∏™‡∏∏‡πà‡∏° S1 ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å
            const Q6_FINALE = globalS1Files.find(f => f.is_finale);
            const others = globalS1Files.filter(f => !f.is_finale);
            
            // ‡∏ï‡∏±‡∏î‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (maxTurns - 1)
            selectedRandomFiles = others.slice(0, maxTurns - 1).map(f => f.audio_url);
            
            if (Q6_FINALE && maxTurns > 0) {
                selectedRandomFiles.push(Q6_FINALE.audio_url); // ‡πÉ‡∏™‡πà Final ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
            }
        }
        
        const getCachedAudio = (url) => {
            if(!url) return null;
            if (audioCache[url]) {
                const c = audioCache[url].cloneNode(true);
                c.currentTime = 0;
                return c;
            }
            return new Audio(url);
        }

        // --- Recording Handler ---
        const toggleRecording = async function(type) {
            let btn, statusEl, nextAction, labelText;
            let part, qNum, qText, urlLog = lastCustomerAudioUrl;

            // Map Type to Variables
            if(type === 1) { // S1 Employee
                part = 1; qNum = turn + 1; qText = `S1-T${qNum} Opening`;
                btn = window.recordBtn; statusEl = window.s1StatusElement; nextAction = endTurn;
                labelText = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)';
            } else if (type === 8) { // S1.5 Pitch
                part = 15; qNum = 1; qText = 'S1.5 Product Pitch';
                btn = window.pitchRecordBtn; statusEl = window.pitchStatusElement; nextAction = endPitch;
                labelText = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠';
            } else if (type === 2) { // S2 Answer
                part = 2; qNum = qRound; qText = `S2-Q${qNum} Answer`;
                btn = window.answerBtn; statusEl = window.s2StatusElement; nextAction = playS2;
                labelText = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
            } else if (type === 3) { // S3 Close
                part = 3; qNum = 0; qText = 'S3 Closing Script';
                btn = window.closeBtn; statusEl = window.s3StatusElement; nextAction = playS3Obj;
                labelText = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';
            } else if (type === 4) { // S3 Reply Objection
                part = 3; qNum = cRound + 1; qText = `S3-Objection${cRound+1} Reply`;
                btn = window.replyBtn; statusEl = window.s3StatusElement; nextAction = startNextCloseRound;
                labelText = 'üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á';
            } else if (type === 5) { // S4 Health Main
                part = 4; qNum = currentHIndex + 1; qText = `S4-Q${qNum} Health Main`;
                btn = window.answerHBtn; statusEl = window.hStatusElement; nextAction = playS4Reply;
                labelText = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
            } else if (type === 7) { // S4 Follow Up
                part = 4; qNum = (currentHIndex + 1) * 10 + followUpStep; qText = `S4-Q${currentHIndex+1}-F${followUpStep} FollowUp`;
                btn = window.followUpQBtn; statusEl = window.hStatusElement; nextAction = playS4FollowUpReply;
                labelText = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥`;
            } else if (type === 6) { // S5 Registration
                part = 5; qNum = aRound; qText = `S5-Step${aRound} Registration`;
                btn = window.answerABtn; statusEl = window.aStatusElement; nextAction = playS5Reply;
                labelText = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô`;
            }

            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                // START
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    let chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        storeRecording(blob, part, qNum, qText, urlLog);
                        btn.disabled = true; btn.textContent = labelText;
                        setTimeout(nextAction, 100);
                        stream.getTracks().forEach(t => t.stop());
                        mediaRecorder = null;
                    };
                    mediaRecorder.start();
                    btn.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
                    statusEl.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
                } catch (err) {
                    alert("Mic Error: " + err.message);
                }
            } else {
                // STOP
                mediaRecorder.stop();
            }
        }

        const storeRecording = (blob, part, qNum, qText, custUrl) => {
            allRecordings.push({ blob, part, qNum, qText, custUrl });
            console.log(`Saved: P${part}-Q${qNum}`);
        }

        // --- Sequence Functions ---

        // S1 Logic
        const endTurn = () => {
            if (turn < maxTurns) {
                turn++;
                window.turnSpan.textContent = turn;
                const file = selectedRandomFiles[turn - 1];
                const isFinal = (turn === maxTurns);
                
                playAudio('customerAudio', file, window.s1StatusElement, () => {
                    lastCustomerAudioUrl = file;
                    if (isFinal) {
                        window.s1StatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡πâ‡∏ß";
                        window.nextRoundBtn.disabled = false;
                    } else {
                        window.s1StatusElement.textContent = `üé§ ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ${turn+1}: ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á`;
                        window.recordBtn.disabled = false;
                    }
                });
            }
        }

        // S1.5 Logic
        const endPitch = () => {
            window.pitchStatusElement.textContent = "üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
            window.nextSection2Btn.disabled = false;
        }

        // S2 Logic
        const playS2 = () => {
             // Logic: ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -> ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
             // ‡πÅ‡∏ï‡πà S2 ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô"
             window.s2StatusElement.textContent = "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
             window.startQBtn.disabled = false;
             if (qRound >= maxQ) {
                 window.nextSection3Btn.disabled = false;
                 window.startQBtn.disabled = true;
                 window.s2StatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2";
             }
        }
        
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° S2 (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        window.startQBtn.addEventListener('click', () => {
            if (qRound < maxQ) {
                qRound++;
                if(window.qRoundSpan) window.qRoundSpan.textContent = qRound;
                
                // 1. Debug: ‡∏Ç‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
                console.log(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á S2 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${qRound} (Product: ${document.getElementById('inputProductType').value})`);
                console.log("üìÇ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå S2 ‡∏ó‡∏µ‡πà‡∏°‡∏µ:", globalS2Files);

                // 2. Fix: ‡πÉ‡∏ä‡πâ == (Loose Equality) ‡πÅ‡∏ó‡∏ô === ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á "1" ‡πÅ‡∏•‡∏∞ 1
                const s2Obj = globalS2Files.find(f => f.q_index == qRound);
                
                if (!s2Obj) {
                    console.error(`‚ùå Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö q_index = ${qRound}`);
                    alert(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á S2 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${qRound}\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô Database ‡∏ï‡∏≤‡∏£‡∏≤‡∏á questions_s2 ‡∏°‡∏µ q_index ‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞ product_type ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`);
                    if(window.s2StatusElement) window.s2StatusElement.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏õ)";
                    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
                }

                const file = s2Obj.audio_url;
                console.log("‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á:", file);
                
                // 3. Play Audio
                playAudio('questionAudio', file, window.s2StatusElement, () => {
                     lastCustomerAudioUrl = file;
                     window.answerBtn.disabled = false;
                     window.startQBtn.disabled = true;
                     if(window.s2StatusElement) window.s2StatusElement.textContent = "üé§ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
                });
            }
        });
        // S3 Logic
        const playS3Obj = () => {
            // ‡∏à‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ -> ‡πÄ‡∏•‡πà‡∏ô Objection ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1
            if(cRound < maxC) {
                playNextObjection();
            }
        }
        const startNextCloseRound = () => {
            // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö Objection -> ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏•‡πà‡∏ô Objection ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if (cRound < maxC) {
                setTimeout(playNextObjection, 500);
            } else {
                window.s3StatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3";
                window.nextSection4Btn.disabled = false;
                window.replyBtn.disabled = true;
            }
        }
        const playNextObjection = () => {
            cRound++;
            window.cRoundSpan.textContent = cRound;
            const s3Obj = globalS3Files.find(f => f.ob_index === cRound);
            const file = s3Obj ? s3Obj.audio_url : null;
            
            playAudio('objectionAudio', file, window.s3StatusElement, () => {
                lastCustomerAudioUrl = file;
                window.replyBtn.disabled = false;
                window.closeBtn.disabled = true;
                window.s3StatusElement.textContent = `üé§ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏ó‡∏µ‡πà ${cRound}`;
            });
        }

        // S4 Logic (Health)
        const updateS4UI = () => {
            const display = document.getElementById('healthQuestionDisplay');
            if (isFollowUpMode) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Follow up
                const fNameObj = globalS4FollowUpNames.find(f => f.step_index === followUpStep);
                const fName = fNameObj ? fNameObj.step_name : `Follow Up ${followUpStep}`;
                window.hQName.textContent = `‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${followUpStep}`;
                display.innerHTML = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: <strong>${fName}</strong>`;
            } else {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
                if (currentHIndex < maxH) {
                    const qText = globalS4Questions[currentHIndex];
                    window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}`;
                    display.innerHTML = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å: <strong>${qText}</strong>`;
                } else {
                     display.innerHTML = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
                }
            }
        }

        const playS4Reply = () => {
            // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
            let file = NO_ANSWER_URL;
            let isYes = false;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà Yes Trigger ‡πÑ‡∏´‡∏°?
            // (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Index ‡∏Å‡∏±‡∏ö Index ‡∏Ç‡∏≠‡∏á selectedDisease)
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: currentHIndex ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0
            // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏ß‡πà‡∏≤ selectedDisease ‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡πÉ‡∏ô array globalS4Data (Raw logic)
            // ‡πÅ‡∏ï‡πà‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ q_text ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏° ‡∏´‡∏£‡∏∑‡∏≠ check flag ‡∏ï‡∏≠‡∏ô init
            
            // Logic ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤ selectedDisease ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞ currentHIndex ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
            // *‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á* globalS4Questions ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà array string
            // ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ globalS4Data ‡∏ï‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ selectedDisease ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô startTest
            
            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö q_text ‡∏Ç‡∏≠‡∏á selectedDisease
            const currentQText = globalS4Questions[currentHIndex];
            if (selectedDisease && selectedDisease.q_text === currentQText) {
                isYes = true;
                file = selectedDisease.yes_trigger_url;
            }

            playAudio('healthAudio', file, window.hStatusElement, () => {
                lastCustomerAudioUrl = file;
                if (isYes) {
                    // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    isFollowUpMode = true;
                    followUpStep = 1;
                    window.answerHBtn.style.display = 'none';
                    if(!window.followUpQBtn) createFollowUpBtn();
                    window.followUpQBtn.style.display = 'inline-block';
                    window.followUpQBtn.disabled = false;
                    updateS4UI();
                    window.hStatusElement.textContent = "üé§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥' -> ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
                } else {
                    // ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    nextHealthMain();
                }
            });
        }

        const playS4FollowUpReply = () => {
            const replyObj = globalS4FollowUpReplies.find(f => f.step_index === followUpStep);
            const file = replyObj ? replyObj.customer_audio_url : null;
            
            playAudio('healthAudio', file, window.hStatusElement, () => {
                lastCustomerAudioUrl = file;
                followUpStep++;
                if (followUpStep > maxFollowUp) {
                    // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    isFollowUpMode = false;
                    window.followUpQBtn.style.display = 'none';
                    window.answerHBtn.style.display = 'inline-block';
                    nextHealthMain();
                } else {
                    window.followUpQBtn.disabled = false;
                    updateS4UI();
                    window.hStatusElement.textContent = "üé§ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
                }
            });
        }

        const nextHealthMain = () => {
            currentHIndex++;
            if (currentHIndex < maxH) {
                window.answerHBtn.disabled = false;
                updateS4UI();
                window.hStatusElement.textContent = "üé§ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
            } else {
                window.nextSection5Btn.disabled = false;
                window.answerHBtn.disabled = true;
                window.hStatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4";
            }
        }

        const createFollowUpBtn = () => {
            const btn = document.createElement('button');
            btn.id = 'followUpQBtn';
            btn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
            btn.style.backgroundColor = '#17a2b8';
            btn.style.color = 'white';
            btn.addEventListener('click', () => toggleRecording(7));
            window.nextSection5Btn.parentNode.insertBefore(btn, window.nextSection5Btn);
            window.followUpQBtn = btn;
        }

        // S5 Logic (Registration)
        const updateS5UI = () => {
            const list = document.getElementById('stepList');
            list.innerHTML = '';
            globalS5Steps.forEach((s, i) => {
                const li = document.createElement('li');
                li.textContent = s.step_name;
                if (i + 1 === aRound) {
                    li.style.color = 'blue'; li.style.fontWeight = 'bold';
                }
                list.appendChild(li);
            });
        }

        const playS5Reply = () => {
            const stepObj = globalS5Steps.find(s => s.step_index === aRound);
            const file = stepObj ? stepObj.customer_audio_url : null;

            playAudio('agreementAudio', file, window.aStatusElement, () => {
                lastCustomerAudioUrl = file;
                aRound++;
                if (aRound <= maxA) {
                    window.answerABtn.disabled = false;
                    updateS5UI();
                    window.aStatusElement.textContent = "üé§ ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ñ‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
                } else {
                    window.finalSaveBtn.disabled = false;
                    window.answerABtn.disabled = true;
                    window.aStatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 5 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
                }
            });
        }

        // Helper Play Audio
        const playAudio = (elementId, url, statusEl, onEndedCallback) => {
            if (!url) {
                console.warn("No URL to play");
                if (onEndedCallback) onEndedCallback();
                return;
            }
            statusEl.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
            const el = document.getElementById(elementId);
            const cached = getCachedAudio(url);
            
            // Swap src and play (or use cached object logic if preferred, but simple src swap is stable for DOM)
            el.src = url;
            el.play().then(() => {
                el.onended = () => {
                    statusEl.textContent = "‚úÖ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
                    if (onEndedCallback) onEndedCallback();
                };
            }).catch(e => {
                statusEl.textContent = "‚ùå Auto-play blocked. Click to retry.";
                console.error(e);
            });
        }


        // --- 8. Navigation & Upload ---
        
        // Navigation Listeners
        window.nextRoundBtn.addEventListener('click', () => { 
            document.getElementById('section1Div').style.display='none'; 
            document.getElementById('section1_5Div').style.display='block';
            window.pitchRecordBtn.disabled = false;
        });
        window.nextSection2Btn.addEventListener('click', () => {
            document.getElementById('section1_5Div').style.display='none';
            document.getElementById('section2Div').style.display='block';
            window.startQBtn.disabled = false;
        });
        window.nextSection3Btn.addEventListener('click', () => {
            document.getElementById('section2Div').style.display='none';
            document.getElementById('section3Div').style.display='block';
            window.closeBtn.disabled = false;
        });
        window.nextSection4Btn.addEventListener('click', () => {
            document.getElementById('section3Div').style.display='none';
            document.getElementById('section4Div').style.display='block';
            window.answerHBtn.disabled = false;
            updateS4UI();
        });
        window.nextSection5Btn.addEventListener('click', () => {
            document.getElementById('section4Div').style.display='none';
            document.getElementById('section5Div').style.display='block';
            aRound = 1;
            window.answerABtn.disabled = false;
            updateS5UI();
        });

        // Final Upload
        window.finalSaveBtn.addEventListener('click', async () => {
            window.finalSaveBtn.disabled = true;
            window.loadingOverlay.style.display = 'flex';
            window.loadingText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            
            const userName = window.inputUserName.value;
            const group = window.inputUserGroup.value;
            const product = document.getElementById('inputProductType').value; // *‡∏™‡πà‡∏á Product Type ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            
            let count = 0;
            for (const rec of allRecordings) {
                count++;
                window.loadingText.textContent = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà ${count}/${allRecordings.length}`;
                const fileName = `${currentUserId}/${product}/${rec.part}_${rec.qNum}_${uuidv4()}.webm`;
                
                try {
                    // Upload File
                    const { error: upErr } = await window.supabase.storage.from('responses').upload(fileName, rec.blob);
                    if(upErr) throw upErr;
                    
                    const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(fileName);
                    
                    // Insert Record
                    await window.supabase.from('submissions').insert({
                        user_id: currentUserId,
                        name: userName,
                        user_group: group,
                        part_number: rec.part,
                        question_number: rec.qNum, // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô int ‡πÉ‡∏ô DB ‡∏´‡∏£‡∏∑‡∏≠ text ‡∏Å‡πá‡πÑ‡∏î‡πâ
                        question_text: rec.qText,
                        audio_url: publicUrl,
                        customer_audio_url: rec.custUrl,
                        insurance_type: product // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Product Type**
                    });
                    
                } catch (e) {
                    console.error("Upload Failed:", e);
                }
                
                const percent = Math.floor((count / allRecordings.length) * 100);
                window.uploadProgressBar.style.width = `${percent}%`;
            }
            
            window.loadingText.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!";
            setTimeout(() => {
                window.loadingOverlay.style.display = 'none';
                window.finalSaveBtn.classList.add('done');
                window.finalSaveBtn.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
                
                // Show Certificate
                document.getElementById('traineeName').textContent = userName;
                document.getElementById('certProduct').textContent = product.toUpperCase();
                document.getElementById('issueDate').textContent = new Date().toLocaleDateString('th-TH');
                document.getElementById('certificate').style.display = 'block';
                document.getElementById('certificate').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        });
        
        window.certBtn.addEventListener('click', () => {
             document.getElementById('certificate').style.display = 'block';
             document.getElementById('certificate').scrollIntoView();
        });

        // Initialize Listeners
        window.startTestBtn.addEventListener('click', startTest); 
        window.recordBtn.addEventListener('click', () => toggleRecording(1));
        window.pitchRecordBtn.addEventListener('click', () => toggleRecording(8));
        window.answerBtn.addEventListener('click', () => toggleRecording(2));
        window.closeBtn.addEventListener('click', () => toggleRecording(3));
        window.replyBtn.addEventListener('click', () => toggleRecording(4));
        window.answerHBtn.addEventListener('click', () => toggleRecording(5));
        window.answerABtn.addEventListener('click', () => toggleRecording(6));

        // Load Data on Start
        fetchInitialData();

    </script>
</body>
</html>
