<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</title>
    
    <style>
        /* 1. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î (NEW) */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button { 
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 18px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }

        /* Responsive Form Control */
        .form-control {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
        }

        /* Difficulty Radio Styles */
        .difficulty-option {
            display: inline-block;
            margin: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .difficulty-option:hover { border-color: #337ab7; }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7;
            color: white;
            border-color: #337ab7;
            font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000; text-align: center; font-size: 20px;
        }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        
        /* Certificate Style */
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }

        @media (max-width: 600px) {
            .container-box {
                padding: 15px;
                margin: 0 10px;
            }
            h1 { font-size: 28px; }
            h2 { font-size: 20px; }
            button { padding: 10px 20px; font-size: 16px; width: 95%; }
            .difficulty-option { margin: 5px; padding: 8px 15px; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...</h5>
        <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <div style="margin-bottom: 20px;">
                <label for="inputUserName" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
                </label>
                <input type="text" class="form-control" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="inputUserGroup" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <input type="text" class="form-control" id="inputUserGroup" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å" required>
            </div>
            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="easy" checked>
                    <label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                    
                    <input type="radio" id="diffHard" name="difficulty" value="hard">
                    <label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>

                    <input type="radio" id="diffHarder" name="difficulty" value="harder">
                    <label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
                </div>
            </div>
            
            <button id="startTestBtn" style="background-color: #28a745; color: white;">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <hr>
        </div>
        
        <div id="testSection" style="display: none;">
            
            <p>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏£‡∏ß‡∏°: <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span> | Q: <span id="qRound">1</span>/<span id="maxQSpan">10</span> | C: <span id="cRound">1</span>/<span id="maxCSpan">5</span> | H: <span id="currentHSpan">0</span>/<span id="maxHSpan">5</span> | A: <span id="aRound">1</span>/<span id="maxASpan">7</span></p>

            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (T<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio" src=""></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5)</button>
                <p id="s1StatusElement">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)</h2>
                <button id="pitchRecordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3)</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
                <p id="s3StatusElement">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5: ‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>)</h2>
                
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; border-radius: 8px; background-color: #ffeaea; font-weight: bold; font-size: 18px; color: #333;">
                    </div>
                <audio id="healthAudio"></audio>
                <button id="answerHBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
                <p id="hStatusElement">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                
                <div id="registrationStepsDisplay" style="text-align: left; margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <h4 style="color: #333; margin-top: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h4>
                    <ol id="stepList" style="padding-left: 20px; font-size: 16px;">
                        </ol>
                </div>
                <button id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</p>
                <hr>
            </div>

            <div id="certificate" style="display: none;">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
                <h2 id="traineeName">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
                <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                <p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</strong></p>
                <p style="margin-top: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠....................................................</p>
                <p>(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°)</p>
                <p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn" style="display: none;">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- 1. Supabase Config & Global State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // FIX: Product Tag Configuration
        const DEFAULT_PRODUCT_TAG = 'health'; 
        const CURRENT_PRODUCT_TAG = localStorage.getItem('roleplaySelectedProductTag') || DEFAULT_PRODUCT_TAG;
        const FILTER_TAGS = [CURRENT_PRODUCT_TAG]; 

        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
        let productDisplayName = '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (S4 Included)'; 

        // Variables
        let allRecordings = [], mediaRecorder = null, currentUserId = null, audioChunks = [];
        let turn=0, qRound=0, cRound=0, currentHIndex=0, followUpStep=0, aRound=0;
        let isFollowUpMode=false, selectedDisease=null;
        let maxTurns, maxQ, maxC, maxH, maxA, maxFollowUp;
        let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS4Questions=[], globalS4FollowUpNames=[], globalS4FollowUpReplies=[], globalS5Steps=[];
        let audioCache={}, selectedRandomFiles=[], lastCustomerAudioUrl='N/A';
        let selectedS2Files = [], selectedS3Files = []; 
        
        // --- 2. Helper Functions (Required for operation) ---
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const playAudio = (url, statusEl, onEnd) => {
            statusEl.textContent = "üéß ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î...";
            
            // ‡πÉ‡∏ä‡πâ Audio Element ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏° Context
            let audio;
            if (statusEl === window.qStatus) audio = window.questionAudio;
            else if (statusEl === window.s3StatusElement) audio = window.objectionAudio;
            else if (statusEl === window.aStatus) audio = window.agreementAudio;
            else if (statusEl === window.hStatusElement) audio = window.healthAudio;
            else audio = window.customerAudio;

            audio.src = url;
            lastCustomerAudioUrl = url;

            audio.onended = () => {
                statusEl.textContent = "üé§ ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ö";
                if (onEnd) onEnd();
            };
            audio.play().catch(e => {
                console.error("Audio Playback Error:", e);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ (Audio Playback Error) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î OK ‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠");
                statusEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ (‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)";
                if (onEnd) onEnd();
            });
        };

        const hideAll = () => ['section1Div','section1_5Div','section2Div','section3Div','section4Div','section5Div'].forEach(id=>document.getElementById(id).style.display='none');
        
        const updateStepHighlight = function(currentStep) {
            const steps = window.stepList.children;
            for(let i=0; i<steps.length; i++) {
                steps[i].style.fontWeight = (i + 1) === currentStep ? 'bold' : 'normal';
                steps[i].style.color = (i + 1) === currentStep ? '#d9534f' : '#333';
            }
        };

        const generateCertificate = function() {
            window.traineeName.textContent = window.inputUserName.value;
            window.issueDate.textContent = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            window.testSection.style.display = 'none';
            document.getElementById('certificate').style.display = 'block';
        };
        
        const getPartName = (part) => {
            switch (part) {
                case 1: return 'S1_Turn'; case 2: return 'S15_Pitch'; case 3: return 'S2_Answer';
                case 4: return 'S3_Close'; case 5: return 'S3_Reply'; case 6: return 'S4_HealthQ';
                case 7: return 'S4_FollowUp'; case 8: return 'S5_Agree';
                default: return 'Unknown';
            }
        };

        const getQNumForPart = (part) => {
            switch (part) {
                case 1: return turn;
                case 2: return 1; // Pitch is always Q1
                case 3: return qRound;
                case 4: return 1; // Closing statement
                case 5: return cRound;
                case 6: return currentHIndex;
                case 7: return followUpStep;
                case 8: return aRound;
                default: return 0;
            }
        };
        
        const getQTextForPart = (part) => {
            switch (part) {
                case 1: return `S1 T${turn} (${selectedRandomFiles[turn-1]?.name || 'N/A'})`;
                case 2: return `S1.5 Pitch`;
                case 3: return `S2 Q${qRound} (${selectedS2Files[qRound-1]?.q_name || 'N/A'})`;
                case 4: return `S3 Closing Statement`;
                case 5: return `S3 OB${cRound} (${selectedS3Files[cRound-1]?.ob_name || 'N/A'})`;
                case 6: return `S4 Q${currentHIndex} (${globalS4Questions[currentHIndex-1]})`;
                case 7: return `S4 Follow-up Q${followUpStep} (${globalS4FollowUpNames[followUpStep-1]?.step_name || 'N/A'})`;
                case 8: return `S5 Step ${aRound} (${globalS5Steps[aRound-1]?.step_name || 'N/A'})`;
                default: return 'N/A';
            }
        };

        const storeRecording = (audioBlob, part, qNum, qText, customerAudioUrl = 'N/A') => {
            const partName = getPartName(part);
            allRecordings.push({
                blob: audioBlob,
                part: partName,
                q_num: qNum,
                q_text: qText,
                customer_url: customerAudioUrl,
                user_id: currentUserId,
                difficulty: document.querySelector('input[name="difficulty"]:checked').value,
                timestamp: new Date().toISOString()
            });
            console.log(`Recording stored: ${partName} Q${qNum}`);
        };

        const uploadAllRecordings = async () => {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î 0/${allRecordings.length} ‡πÑ‡∏ü‡∏•‡πå...`;
            window.uploadProgressBar.style.width = '0%';
            
            let uploadedCount = 0;
            let errors = 0;

            for (const rec of allRecordings) {
                const fileName = `${rec.part}_${rec.q_num}_${rec.user_id}.webm`;
                const storagePath = `responses/${rec.user_id}/${fileName}`;
                
                try {
                    // 1. Upload to Supabase Storage
                    const { data: uploadData, error: uploadError } = await window.supabase.storage
                        .from('responses') // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Bucket ‡∏ä‡∏∑‡πà‡∏≠ 'responses' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                        .upload(storagePath, rec.blob, {
                            contentType: 'audio/webm',
                            upsert: false,
                        });

                    if (uploadError) throw uploadError;

                    // 2. Get Public URL
                    const { data: publicUrlData } = window.supabase.storage
                        .from('responses')
                        .getPublicUrl(storagePath);

                    const publicUrl = publicUrlData.publicUrl;

                    // 3. Insert metadata into 'submissions' table
                    const { error: insertError } = await window.supabase.from('submissions').insert({
                        user_id: rec.user_id,
                        full_name: window.inputUserName.value,
                        user_group: window.inputUserGroup.value,
                        difficulty: rec.difficulty,
                        part: rec.part,
                        q_num: rec.q_num,
                        q_text: rec.q_text,
                        employee_audio_url: publicUrl,
                        customer_audio_url: rec.customer_url,
                        timestamp: rec.timestamp,
                    });

                    if (insertError) throw insertError;

                    uploadedCount++;
                } catch (err) {
                    console.error(`Failed to upload ${fileName}:`, err);
                    errors++;
                }

                // Update progress bar
                const progress = Math.round((uploadedCount / allRecordings.length) * 100);
                window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${uploadedCount}/${allRecordings.length} ‡πÑ‡∏ü‡∏•‡πå...`;
                window.uploadProgressBar.style.width = `${progress}%`;
            }

            window.loadingOverlay.style.display = "none";
            
            if (errors > 0) {
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${errors} ‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö`);
            } else {
                window.finalSaveBtn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!';
                window.finalSaveBtn.classList.add('done');
                window.finalSaveBtn.disabled = true;
                window.certBtn.style.display = 'block';
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!");
            }
        };
        
        const saveAllRecordings = () => { uploadAllRecordings(); };
        
        const toggleRecording = async function(part, button) {
            
            const currentStatusEl = (part === 1) ? window.s1StatusElement :
                                    (part === 2) ? window.pitchStatus :
                                    (part === 3) ? window.qStatus :
                                    (part === 4 || part === 5) ? window.s3StatusElement :
                                    (part === 6 || part === 7) ? window.hStatusElement :
                                    (part === 8) ? window.aStatus : null;

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // 1. STOP Recording
                mediaRecorder.stop();
                button.textContent = (part === 1) ? `üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)` : `üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`;
                button.style.backgroundColor = '#337ab7';
                
                // Disable button during processing
                button.disabled = true;
                if(currentStatusEl) currentStatusEl.textContent = "‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";

                // Return early, onstop will handle next steps
                return;
            }

            // 2. START Recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    // Create Blob and store
                    const audioBlob = new Blob(audioChunks, { 'type' : 'audio/webm; codecs=opus' });
                    storeRecording(audioBlob, part, getQNumForPart(part), getQTextForPart(part), lastCustomerAudioUrl);
                    
                    // Close Stream
                    stream.getTracks().forEach(track => track.stop()); 

                    // Handle Next Flow based on Part
                    switch (part) {
                        case 1: // S1 Turn recording
                            button.disabled = false; // Re-enable button for nextTurn 
                            nextTurn(); // *** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å nextTurn ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ***
                            break;
                        case 2: // S1.5 Pitch recording
                            button.disabled = true;
                            window.nextSection2Btn.disabled = false; // Enable 'Go to S2'
                            if(currentStatusEl) currentStatusEl.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pitch ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå";
                            break;
                        case 3: // S2 Answer recording
                            qRound++;
                            window.qRound.textContent = qRound;
                            if (qRound <= maxQ) {
                                window.startQBtn.disabled = false; // Re-enable Start Question for next round
                                button.disabled = true;
                            } else {
                                button.disabled = true;
                                window.startQBtn.disabled = true;
                                window.nextSection3Btn.disabled = false; // Enable 'Go to S3'
                                if(currentStatusEl) currentStatusEl.textContent = "‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡πâ‡∏ß";
                            }
                            break;
                        case 4: // S3 Closing Statement (Start S3)
                            button.disabled = true;
                            window.replyBtn.disabled = false; // Enable reply button for first objection
                            playSequentialObjectionAuto(); // Start first objection
                            break;
                        case 5: // S3 Reply to Objection
                            cRound++;
                            window.cRound.textContent = cRound;
                            if (cRound <= maxC) {
                                window.replyBtn.disabled = true;
                                startNextCloseRoundAuto(); // Play next objection/close
                            } else {
                                button.disabled = true;
                                window.nextSection4Btn.disabled = false; // Enable 'Go to S4'
                                if(currentStatusEl) currentStatusEl.textContent = "‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß";
                            }
                            break;
                        case 6: // S4 Health Question
                        case 7: // S4 Follow-up Question
                            playFixedHealthQuestion(); // Continue S4 flow
                            button.disabled = false;
                            break;
                        case 8: // S5 Agreement Question
                            aRound++;
                            window.aRound.textContent = aRound;
                            if (aRound <= maxA) {
                                playCustomerReplyAndSetupNextStep(); // Continue S5 flow
                                button.disabled = false;
                            } else {
                                button.disabled = true;
                                window.finalSaveBtn.disabled = false; // Enable Final Save
                                updateStepHighlight(0);
                                if(currentStatusEl) currentStatusEl.textContent = "‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 5 ‡πÅ‡∏•‡πâ‡∏ß";
                            }
                            break;
                    }
                    if(currentStatusEl && mediaRecorder.state !== 'recording') currentStatusEl.textContent = "üé§ ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ö";
                    
                    // Re-enable button if flow logic didn't disable it
                    if (button.disabled === true) {
                        // Status is set by flow logic
                    }
                    
                };

                mediaRecorder.start();
                button.textContent = `üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î`;
                button.style.backgroundColor = 'red';
                
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
            }
        };

        // --- Flow Control Functions ---

        const prepareTurnFiles = function() {
            // Select random files for S1 based on maxTurns
            const shuffledS1 = shuffleArray([...globalS1Files]).filter(f => !f.is_finale);
            
            // Get the final closing file
            const finaleFile = globalS1Files.find(f => f.is_finale);
            
            // Select maxTurns-1 random non-finale files, then add the finale file
            selectedRandomFiles = [...shuffledS1.slice(0, maxTurns - 1)];
            if(finaleFile && maxTurns > 0) {
                 selectedRandomFiles.push(finaleFile);
            }

            // Start first turn
            window.recordBtn.disabled = false;
        }

        // *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô nextTurn ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ***
        const nextTurn = function() {
            window.recordBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            window.nextRoundBtn.disabled = true;
            
            // ‡πÉ‡∏ä‡πâ turn - 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const currentTurnFile = selectedRandomFiles[turn - 1]; 
            
            if (currentTurnFile) {
                // *** ‡πÉ‡∏ä‡πâ currentTurnFile.audio_url ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Supabase ***
                playAudio(currentTurnFile.audio_url, window.s1StatusElement, () => {
                    // *** ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö ***
                    if (turn < maxTurns) {
                        // 1. ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢): ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        turn++;
                        window.turnSpan.textContent = turn;
                        window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn}/${maxTurns})`;
                        window.recordBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    } else {
                        // 2. ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏à‡∏ö S1
                        window.s1StatusElement.textContent = "‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡πâ‡∏ß";
                        window.nextRoundBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ S1.5
                        window.recordBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    }
                });
            } else {
                 alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• S1");
                 initSection1_5(); 
            }
        };
        
        const initSection1_5 = function() {
            hideAll();
            document.getElementById('section1_5Div').style.display = 'block';
            window.pitchStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå";
            window.pitchRecordBtn.disabled = false;
            window.nextRoundBtn.disabled = true;
        };

        const endPitchRecording = function() {
            window.pitchRecordBtn.disabled = true;
            window.nextSection2Btn.disabled = false;
            window.pitchStatus.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pitch ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå";
        };

        const initSection2 = function() {
            hideAll();
            document.getElementById('section2Div').style.display = 'block';
            qRound = 1;
            window.qRound.textContent = qRound;
            selectedS2Files = shuffleArray([...globalS2Files]).slice(0, maxQ);
            window.startQBtn.disabled = false;
            window.answerBtn.disabled = true;
            window.qStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Q1";
        };

        const playSequentialQuestion = function() {
            window.startQBtn.disabled = true;
            const currentQFile = selectedS2Files[qRound - 1];

            if (currentQFile && currentQFile.audio_url) { // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç audio_url ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ ***
                playAudio(currentQFile.audio_url, window.qStatus, () => {
                    window.answerBtn.disabled = false; // Enable Answer button
                });
            } else {
                alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö S2 Q${qRound}`);
                window.answerBtn.disabled = false;
            }
        };

        const initSection3 = function() {
            hideAll();
            document.getElementById('section3Div').style.display = 'block';
            cRound = 1;
            window.cRound.textContent = cRound;
            selectedS3Files = shuffleArray([...globalS3Files]).slice(0, maxC);
            window.closeBtn.disabled = false;
            window.replyBtn.disabled = true;
            window.s3StatusElement.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
        };

        const playSequentialObjectionAuto = function() {
             window.closeBtn.disabled = true;
             const currentObjection = selectedS3Files[cRound - 1];

             if (currentObjection && currentObjection.audio_url) { // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç audio_url ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ ***
                 playAudio(currentObjection.audio_url, window.s3StatusElement, () => {
                     window.replyBtn.disabled = false; // Enable Reply button
                 });
             } else {
                 alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö S3 OB${cRound}`);
                 window.replyBtn.disabled = false;
             }
        };
        
        const startNextCloseRoundAuto = function() {
            window.replyBtn.disabled = true;
            if (cRound <= maxC) {
                playSequentialObjectionAuto(); // Play next objection
            } else {
                // Done
                window.replyBtn.disabled = true;
                window.nextSection4Btn.disabled = false;
            }
        };

        const initSection4 = function() {
            hideAll();
            document.getElementById('section4Div').style.display = 'block';
            currentHIndex = 1;
            followUpStep = 0;
            isFollowUpMode = false;
            window.answerHBtn.disabled = false;
            window.nextSection5Btn.disabled = true;
            updateHealthQuestionUI();
            window.hStatusElement.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û Q1";
        };

        const updateHealthQuestionUI = function() {
            if (isFollowUpMode) {
                window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (F${followUpStep}/${maxFollowUp})`;
                window.healthQuestionDisplay.textContent = globalS4FollowUpNames[followUpStep - 1]?.step_name || 'N/A';
            } else {
                window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentHIndex}/${maxH}`;
                window.healthQuestionDisplay.textContent = globalS4Questions[currentHIndex - 1] || 'N/A';
            }
        };
        
        const playFixedFollowUpQuestion = function() {
            followUpStep++;
            window.currentHSpan.textContent = `${currentHIndex} (F${followUpStep})`;
            updateHealthQuestionUI();

            const followUpReply = globalS4FollowUpReplies[followUpStep - 1];

            if (followUpStep <= maxFollowUp && followUpReply && followUpReply.audio_url) { // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç audio_url ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ ***
                playAudio(followUpReply.audio_url, window.hStatusElement, () => {
                    window.answerHBtn.disabled = false;
                });
            } else {
                // Done with follow-up
                isFollowUpMode = false;
                currentHIndex++;
                window.currentHSpan.textContent = currentHIndex;
                playFixedHealthQuestion(); // Move to next main question or finish
            }
        }

        const playFixedHealthQuestion = function() {
            window.answerHBtn.disabled = true;
            
            // Check for follow-up state (after employee records FQ)
            if (isFollowUpMode) {
                if (followUpStep < maxFollowUp) {
                    playFixedFollowUpQuestion();
                    return;
                } else {
                    isFollowUpMode = false;
                }
            }
            
            // Check for main question state (after employee records MQ or after Follow-up ends)
            if (currentHIndex <= maxH) {
                updateHealthQuestionUI();
                
                // --- Simple Logic: Q4 is the Yes Trigger ---
                if (currentHIndex === 4 && selectedDisease) {
                    // This is the trigger Q (Simulate Customer Answer 'Yes')
                    isFollowUpMode = true;
                    maxFollowUp = globalS4FollowUpNames.length;
                    
                    playAudio(selectedDisease.yes_trigger_url, window.hStatusElement, () => {
                        window.hStatusElement.textContent = "üé§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö '‡πÉ‡∏ä‡πà' - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
                        playFixedFollowUpQuestion(); // Start follow-up flow
                    });
                    
                } else {
                    // Normal Question (Simulate Customer Answer 'No')
                    playAudio(NO_ANSWER_URL, window.hStatusElement, () => {
                        currentHIndex++;
                        window.currentHSpan.textContent = currentHIndex;
                        window.answerHBtn.disabled = false; // Ready for next question
                    });
                }
            } else {
                // Done with S4
                window.hStatusElement.textContent = "‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡πâ‡∏ß";
                window.nextSection5Btn.disabled = false;
                window.answerHBtn.disabled = true;
            }
        };

        const initSection5 = function() {
            hideAll();
            document.getElementById('section5Div').style.display = 'block';
            aRound = 1;
            window.aRound.textContent = aRound;
            renderRegistrationSteps();
            window.answerABtn.disabled = false;
            window.finalSaveBtn.disabled = true;
            updateStepHighlight(aRound);
            window.aStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1";
        };
        
        const playCustomerReplyAndSetupNextStep = function() {
            window.answerABtn.disabled = true;
            const currentStep = globalS5Steps[aRound - 1];

            if (currentStep && currentStep.audio_url) { // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç audio_url ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ ***
                playAudio(currentStep.audio_url, window.aStatus, () => {
                    aRound++;
                    window.aRound.textContent = aRound;
                    updateStepHighlight(aRound);
                    if(aRound <= maxA) {
                         window.answerABtn.disabled = false;
                    } else {
                        // All steps done (Final save button enabled by toggleRecording)
                    }
                });
            } else {
                alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö S5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${aRound}`);
                aRound++;
                window.aRound.textContent = aRound;
                updateStepHighlight(aRound);
                window.answerABtn.disabled = false;
            }
        };
        
        const renderRegistrationSteps = function() {
            window.stepList.innerHTML = ''; 
            globalS5Steps.forEach((s, i) => {
                const li = document.createElement('li');
                li.id = `reg-step-${i + 1}`;
                li.textContent = s.step_name;
                window.stepList.appendChild(li);
            });
        }
        
        // --- Core Functions: fetchInitialData (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Health) ---
        const fetchInitialData = async function() {
            window.loadingOverlay.style.display = "flex";
            try {
                // *** FIX: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å overlaps ‡πÄ‡∏õ‡πá‡∏ô filter/cs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ Error 400 ***
                const filterQuery = `{${CURRENT_PRODUCT_TAG}}`;

                // 1. Config
                const { data: cData } = await window.supabase.from('difficulty_config').select('*');
                cData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });

                // 2. S1 (FILTERED)
                const { data: s1 } = await window.supabase.from('customer_replies_s1').select('turn_index, is_finale, product_type, audio_url').filter('product_type', 'cs', filterQuery).order('turn_index');
                globalS1Files = s1 || [];
                
                // 3. S2 (FILTERED)
                const { data: s2 } = await window.supabase.from('questions_s2').select('q_index, product_type, audio_url, q_name').filter('product_type', 'cs', filterQuery).order('q_index');
                globalS2Files = s2 || [];
                
                // 4. S3 (FILTERED)
                const { data: s3 } = await window.supabase.from('objections_s3').select('ob_index, product_type, audio_url, ob_name').filter('product_type', 'cs', filterQuery).order('ob_index');
                globalS3Files = s3 || [];
                
                // 5. S4 Questions (FILTERED)
                const { data: s4 } = await window.supabase.from('health_questions_s4').select('q_index, product_type, q_text, is_yes_trigger, yes_trigger_url').filter('product_type', 'cs', filterQuery).order('q_index');
                globalS4Questions = (s4 || []).map(q => q.q_text);
                selectedDisease = (s4||[]).find(q => q.is_yes_trigger) || {name: '‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', yes_trigger_url: NO_ANSWER_URL};
                
                // 6. S4 Follow-up Names (FILTERED)
                const { data: s4n } = await window.supabase.from('s4_follow_up_names').select('*').filter('product_type', 'cs', filterQuery).order('step_index');
                globalS4FollowUpNames = s4n || [];
                
                // 7. S4 Follow-up Replies (FILTERED)
                const { data: s4r } = await window.supabase.from('s4_follow_up_replies').select('step_index, product_type, audio_url').filter('product_type', 'cs', filterQuery).order('step_index');
                globalS4FollowUpReplies = s4r || [];
                
                // 8. S5 (FILTERED)
                const { data: s5 } = await window.supabase.from('scripts_s5').select('step_index, product_type, step_name, audio_url').filter('product_type', 'cs', filterQuery).order('step_index');
                globalS5Steps = s5 || [];
                
                window.loadingOverlay.style.display = "none";
                return true;
            } catch (err) {
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message + "\n\n(‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policy ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase)");
                window.loadingOverlay.style.display = "none";
                return false;
            }
        };

        // --- 4. Initialization and DOM Assignment ---
        const initializeUserAndDOM = async function() {
            // A. Assign DOM Elements to window (Binding)
            window.inputUserName = document.getElementById('inputUserName'); 
            window.inputUserGroup = document.getElementById('inputUserGroup');
            window.registrationSection = document.getElementById('registrationSection');
            window.testSection = document.getElementById('testSection');
            window.startTestBtn = document.getElementById('startTestBtn');
            window.customerAudio = document.getElementById('customerAudio');
            window.questionAudio = document.getElementById('questionAudio');
            window.objectionAudio = document.getElementById('objectionAudio');
            window.agreementAudio = document.getElementById('agreementAudio');
            window.s1StatusElement = document.getElementById('s1StatusElement');
            window.pitchStatus = document.getElementById('pitchStatus');
            window.qStatus = document.getElementById('qStatus');
            window.s3StatusElement = document.getElementById('s3StatusElement');
            window.hStatusElement = document.getElementById('hStatusElement'); // S4 Status
            window.aStatus = document.getElementById('aStatus');
            window.recordBtn = document.getElementById('recordBtn');
            window.nextRoundBtn = document.getElementById('nextRoundBtn');
            window.pitchRecordBtn = document.getElementById('pitchRecordBtn');
            window.nextSection2Btn = document.getElementById('nextSection2Btn');
            window.startQBtn = document.getElementById('startQBtn');
            window.answerBtn = document.getElementById('answerBtn');
            window.nextSection3Btn = document.getElementById('nextSection3Btn');
            window.closeBtn = document.getElementById('closeBtn');
            window.replyBtn = document.getElementById('replyBtn');
            window.nextSection4Btn = document.getElementById('nextSection4Btn');
            window.answerHBtn = document.getElementById('answerHBtn');
            window.nextSection5Btn = document.getElementById('nextSection5Btn');
            window.answerABtn = document.getElementById('answerABtn');
            window.finalSaveBtn = document.getElementById('finalSaveBtn');
            window.certBtn = document.getElementById('certBtn');
            window.traineeName = document.getElementById('traineeName');
            window.issueDate = document.getElementById('issueDate');
            window.stepList = document.getElementById('stepList');
            window.hQName = document.getElementById('hQName');
            window.turnSpan = document.getElementById('turnSpan');
            window.maxTurnSpan = document.getElementById('maxTurnSpan');
            window.qRound = document.getElementById('qRound');
            window.maxQSpan = document.getElementById('maxQSpan');
            window.cRound = document.getElementById('cRound');
            window.maxCSpan = document.getElementById('maxCSpan');
            window.aRound = document.getElementById('aRound');
            window.maxASpan = document.getElementById('maxASpan');
            window.loadingOverlay = document.getElementById('loadingOverlay');
            window.loadingText = document.getElementById('loadingText');
            window.uploadProgressBar = document.getElementById('uploadProgressBar');


            // B. Auto Fill Logic (FIXED)
            const storedUserData = localStorage.getItem('roleplayUserData');

            if(await fetchInitialData()) {
                document.querySelector('h1').textContent = `E-Simulator Roleplay (${productDisplayName})`;
                if (storedUserData) {
                    try {
                        const userData = JSON.parse(storedUserData);
                        // FIX: Auto Fill ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input text (Name and Department)
                        window.inputUserName.value = userData.fullName || '';
                        window.inputUserGroup.value = userData.department || '';
                        
                        const storedDiff = localStorage.getItem('roleplayDifficulty');
                        if(storedDiff) {
                            const diffRadio = document.querySelector(`input[name="difficulty"][value="${storedDiff}"]`);
                            if(diffRadio) diffRadio.checked = true;
                        }
                    } catch (e) {
                        console.error("Error parsing user data from localStorage:", e);
                    }
                }
            }


            // C. Main Start Function (Binding)
            const startTest = async () => {
                const fullName = window.inputUserName.value.trim();
                const userGroup = window.inputUserGroup.value.trim();
                const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
                const config = globalConfig[selectedDifficulty];

                if (!fullName || !userGroup) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                    return;
                }
                
                if (!config) {
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å "${selectedDifficulty}" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
                    return;
                }

                // Set max values
                maxTurns = config.S1;
                maxQ = config.S2;
                maxC = config.S3;
                maxH = config.S4;
                maxA = config.S5; 

                // Update UI max values
                window.maxTurnSpan.textContent = maxTurns;
                window.maxQSpan.textContent = maxQ;
                window.maxCSpan.textContent = maxC;
                window.maxHSpan.textContent = maxH;
                window.maxASpan.textContent = maxA; 

                window.registrationSection.style.display = 'none';
                window.testSection.style.display = 'block';

                hideAll();
                document.getElementById('section1Div').style.display = 'block';

                turn = 1; // Start at Turn 1
                window.turnSpan.textContent = turn;
                window.currentHSpan.textContent = '0'; // Reset S4 UI
                window.qRound.textContent = '1';
                window.cRound.textContent = '1';
                window.aRound.textContent = '1';

                // Set current user ID
                currentUserId = uuidv4();

                prepareTurnFiles(); 
                window.nextRoundBtn.disabled = true;
                window.recordBtn.disabled = false;
                window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
            };

            // D. Bind Start Button
            window.startTestBtn.onclick = startTest;

            // E. Bind Other Buttons (Ensure all handlers are defined in the complete code)
            window.recordBtn.onclick = () => toggleRecording(1, window.recordBtn);
            window.nextRoundBtn.onclick = initSection1_5;
            window.pitchRecordBtn.onclick = () => toggleRecording(2, window.pitchRecordBtn);
            window.nextSection2Btn.onclick = initSection2;
            window.startQBtn.onclick = playSequentialQuestion;
            window.answerBtn.onclick = () => toggleRecording(3, window.answerBtn);
            window.nextSection3Btn.onclick = initSection3;
            window.closeBtn.onclick = () => toggleRecording(4, window.closeBtn);
            window.replyBtn.onclick = () => toggleRecording(5, window.replyBtn);
            window.nextSection4Btn.onclick = initSection4;
            window.answerHBtn.onclick = () => toggleRecording(6, window.answerHBtn);
            window.nextSection5Btn.onclick = initSection5;
            window.answerABtn.onclick = () => toggleRecording(8, window.answerABtn); // Part 8 for S5
            window.finalSaveBtn.onclick = saveAllRecordings;
            window.certBtn.onclick = generateCertificate;
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
    </script>
</body>
</html>
