<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (Ultimate Fixed)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button { 
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 18px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }

        .form-control {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
        }

        .difficulty-option {
            display: inline-block;
            margin: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .difficulty-option:hover { border-color: #337ab7; }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7;
            color: white;
            border-color: #337ab7;
            font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000; text-align: center; font-size: 20px;
        }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }

        @media (max-width: 600px) {
            .container-box {
                padding: 15px;
                margin: 0 10px;
            }
            h1 { font-size: 28px; }
            h2 { font-size: 20px; }
            button { padding: 10px 20px; font-size: 16px; width: 95%; }
            .difficulty-option { margin: 5px; padding: 8px 15px; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...</h5>
        <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (Full Option)</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            
            <div style="margin-bottom: 20px;">
                <label for="inputUserName" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
                </label>
                <input type="text" class="form-control" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="inputProductType" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <select class="form-control" id="inputProductType" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô --</option>
                    <option value="health">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health)</option>
                    <option value="saving1">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 1 (Saving1)</option>
                    <option value="saving2">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 2 (Saving2)</option> 
                    <option value="retirement">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç (Retirement)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="inputUserGroup" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <select class="form-control" id="inputUserGroup" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                    <option value="Nursery">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà</option>
                    <option value="NewTSRsOnboarding">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs On boarding</option>
                    <option value="NewTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs</option>
                    <option value="ExistingTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° TSRs existing</option>
                </select>
            </div>
            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="easy" checked>
                    <label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                    
                    <input type="radio" id="diffHard" name="difficulty" value="hard">
                    <label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>

                    <input type="radio" id="diffHarder" name="difficulty" value="harder">
                    <label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
                </div>
            </div>
            
            <button id="startTestBtn" style="background-color: #28a745; color: white;">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <hr>
        </div>
        
        <div id="testSection" style="display: none;">
            
            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio" src=""></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5)</button>
                <p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Q <span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5: ‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>)</h2>
                
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; border-radius: 8px; background-color: #ffeaea; font-weight: bold; font-size: 18px; color: #333;">
                    <p>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å: ‡πÉ‡∏ô 5 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö ‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                </div>
                <audio id="healthAudio"></audio>
                <button disabled id="answerHBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
                <p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                
                <div id="registrationStepsDisplay" style="text-align: left; margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <h4 style="color: #333; margin-top: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h4>
                    <ol id="stepList" style="padding-left: 20px; font-size: 16px;">
                        </ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</p>
                <hr>
            </div>

            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
                <h2 id="traineeName">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
                <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                <p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</strong></p>
                <p style="margin-top: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠....................................................</p>
                <p>(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°)</p>
                <p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- 1. Supabase Config & Global State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // State Variables
        let mediaRecorder = null;
        const USER_ID_KEY = 'roleplay_user_id'; // üëà FIX: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
        let currentUserId = localStorage.getItem(USER_ID_KEY) || uuidv4();
        localStorage.setItem(USER_ID_KEY, currentUserId);
        
        let allRecordings = []; 
        let lastCustomerAudioUrl = 'N/A';
        let userGroup = ''; 
        let selectedProductType = ''; 
        
        let turn = 0, qRound = 0, cRound = 0, currentHIndex = 0, followUpStep = 0, aRound = 0;
        let isFollowUpMode = false;
        let maxTurns, maxQ, maxC, maxH, maxFollowUp = 5, maxA; 
        
        let globalConfig = {}, globalS1Files = {}, globalS2Files = {}, globalS3Files = {}, globalS4Questions = {}, globalS4FollowUpNames = {}, globalS4FollowUpReplies = {}, globalS5Steps = {};
        
        let audioCache = {};
        let selectedRandomFiles = []; 
        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
        
        const H_FOLLOW_UP_NAMES_HARDCODE = [ "1. ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", "2. ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", "3. ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå", "4. ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà", "5. ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£" ];
        
        // --- Global DOM Elements (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô initializeUserAndDOM ‡πÅ‡∏•‡∏∞ startTest) ---
        // Span elements for dynamic numbering (‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
        window.turnSpan = null; window.maxTurnSpan = null;
        window.qRoundSpan = null; window.maxQSpan = null;
        window.cRoundSpan = null; window.maxCSpan = null;
        window.aRoundSpan = null; window.maxASpan = null;
        
        // Section Element references
        window.s1StatusElement = null; window.s2StatusElement = null; window.s3StatusElement = null;
        window.hStatusElement = null; window.aStatusElement = null; window.pitchStatusElement = null;
        window.followUpQBtn = null;
        
        // Control Buttons
        window.recordBtn = null; window.nextRoundBtn = null; window.pitchRecordBtn = null; 
        window.nextSection2Btn = null; window.startQBtn = null; window.answerBtn = null;
        window.nextSection3Btn = null; window.closeBtn = null; window.replyBtn = null;
        window.nextSection4Btn = null; window.answerHBtn = null; window.nextSection5Btn = null;
        window.answerABtn = null; window.finalSaveBtn = null;


        // --- Utility Functions ---
        const fetchInitialData = async function() {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö...`;

            try {
                const { data: configData } = await window.supabase.from('difficulty_config').select('*');
                configData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });
                
                // ‚úÖ LOCK ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Tag
                const fetchAndGroup = async (tableName, keyField, groupStore, selectFields = '*') => {
                    const { data, error } = await window.supabase.from(tableName).select(selectFields).order(keyField, { ascending: true });
                    if (error) throw error;
                    
                    data.forEach(item => {
                        if (item.audio_url) item.audio_url = item.audio_url.trim();
                        if (item.customer_audio_url) item.customer_audio_url = item.customer_audio_url.trim();
                        if (item.yes_trigger_url) item.yes_trigger_url = item.yes_trigger_url.trim();

                        const productArray = item.product_type || [];
                        
                        // Loop ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                        productArray.forEach(p => {
                            const product = p.toLowerCase().trim();
                            if (product) {
                                if (!groupStore[product]) groupStore[product] = [];
                                groupStore[product].push(item);
                            }
                        });
                    });
                };

                await fetchAndGroup('customer_replies_s1', 'turn_index', globalS1Files, 'turn_index, is_finale, audio_url, product_type');
                await fetchAndGroup('questions_s2', 'q_index', globalS2Files, 'q_index, q_text, audio_url, product_type');
                await fetchAndGroup('objections_s3', 'ob_index', globalS3Files, 'ob_index, audio_url, product_type');
                await fetchAndGroup('health_questions_s4', 'q_index', globalS4Questions, 'q_index, q_text, is_yes_trigger, yes_trigger_url, product_type');
                await fetchAndGroup('s4_follow_up_names', 'step_index', globalS4FollowUpNames, 'step_index, step_name, product_type');
                await fetchAndGroup('s4_follow_up_replies', 'step_index', globalS4FollowUpReplies, 'step_index, customer_audio_url, product_type');
                await fetchAndGroup('scripts_s5', 'step_index', globalS5Steps, 'step_index, step_name, customer_audio_url, product_type');

                for (const product in globalS4Questions) {
                    const data = globalS4Questions[product] || [];
                    const trigger = data.find(q => q.is_yes_trigger || q.yes_trigger_url) || {}; 
                    globalS4Questions[product].qData = data.map(q => q.q_text);
                    globalS4Questions[product].selectedDisease = trigger ? { disease_name: (trigger.q_text ? trigger.q_text.split(':')[0] : '‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç').trim(), yes_trigger_url: trigger.yes_trigger_url } : {};
                }

                window.loadingText.textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                setTimeout(() => { window.loadingOverlay.style.display = "none"; }, 500);
                return true; 
            } catch (error) { console.error(error); window.loadingText.textContent = `‚ùå Error: ${error.message}`; return false; }
        }

        const getCachedAudioElement = (url) => {
            if (!url) return null;
            if (!audioCache[url]) { audioCache[url] = new Audio(url); }
            const audio = audioCache[url].cloneNode(true);
            audio.currentTime = 0;
            return audio;
        }

        // ‚úÖ LOCK ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö "Strict Mode"
        const prepareTurnFiles = function() {
            const diff = document.querySelector('input[name="difficulty"]:checked').value;
            const max = globalConfig[diff]?.S1 || 5; 
            
            // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ Product ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            let rawFiles = globalS1Files[selectedProductType] || [];

            // üõ°Ô∏è NUCLEAR FILTER: ‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
            const cleanFiles = rawFiles.filter(f => {
                const tags = f.product_type || [];
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô Saving 1 ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ tag "saving2" ‡∏ï‡∏¥‡∏î‡∏°‡∏≤ -> ‡πÄ‡∏ï‡∏∞‡∏ó‡∏¥‡πâ‡∏á!
                if (selectedProductType === 'saving1' && tags.includes('saving2')) return false;
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô Saving 2 ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ tag "saving1" ‡∏ï‡∏¥‡∏î‡∏°‡∏≤ -> ‡πÄ‡∏ï‡∏∞‡∏ó‡∏¥‡πâ‡∏á!
                if (selectedProductType === 'saving2' && tags.includes('saving1')) return false;
                return true;
            });

            selectedRandomFiles = [];
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (1, 2, 3...) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 100%
            for (let i = 1; i < max; i++) {
                const file = cleanFiles.find(f => f.turn_index === i && !f.is_finale);
                if (file) selectedRandomFiles.push(file.audio_url);
                else {
                    console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå S1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${i} ‡∏Ç‡∏≠‡∏á ${selectedProductType}`);
                    selectedRandomFiles.push(null); 
                }
            }
            
            const finale = cleanFiles.find(f => f.is_finale);
            if (finale) selectedRandomFiles.push(finale.audio_url);
            
            console.log(`‚úÖ Final Files for ${selectedProductType}:`, selectedRandomFiles);
        }

        const playAudio = (url, statusEl, btnToEnable, successMsg) => {
            if (!url) { statusEl.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Check DB for ${selectedProductType})`; return undefined; }
            statusEl.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            const audio = getCachedAudioElement(url);
            const attempt = () => {
                audio.play().catch(e => { statusEl.textContent = `‚ùå ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}`; if(btnToEnable) btnToEnable.disabled = false; });
                statusEl.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            };
            if(audio.readyState >= 2) attempt(); else audio.onloadeddata = attempt;
            audio.onended = () => {
                lastCustomerAudioUrl = url;
                statusEl.textContent = successMsg || "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                if(btnToEnable) btnToEnable.disabled = false;
            };
            return audio;
        }

        // --- FLOW FUNCTIONS ---
        const endTurn = () => {
            if (turn < maxTurns) {
                turn++; window.turnSpan.textContent = turn;
                const isFinal = (turn === maxTurns);
                const fileUrl = selectedRandomFiles[turn-1];
                
                if (!fileUrl) {
                    window.s1StatusElement.textContent = `‚ùå Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn} (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å)`;
                    window.recordBtn.disabled = true;
                    if(isFinal) window.nextRoundBtn.disabled = false;
                    return;
                }

                window.customerAudio = playAudio(fileUrl, window.s1StatusElement, isFinal ? window.nextRoundBtn : window.recordBtn, isFinal ? "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1" : "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö");
                if(isFinal) window.recordBtn.disabled = true;
            }
        }
        
        const initSection1_5 = () => {
            document.getElementById('section1Div').style.display='none'; document.getElementById('section1_5Div').style.display='block';
            document.getElementById('section2Div').style.display='none'; // Hide S2
            window.pitchRecordBtn.disabled=false; 
            lastCustomerAudioUrl = 'S1.5 Pitch'; 
            window.pitchStatusElement.textContent = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 1.5"; alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 1.5 Pitch");
        }
        const endPitchRecording = () => { window.pitchStatusElement.textContent = "üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"; window.nextSection2Btn.disabled=false; window.pitchRecordBtn.disabled=true; }
        
        const initSection2 = () => {
            document.getElementById('section1_5Div').style.display='none'; 
            document.getElementById('section2Div').style.display='block'; // Show S2
            window.startQBtn.disabled=false; qRound=0; 
            lastCustomerAudioUrl = 'S2 Start'; window.s2StatusElement.textContent = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 2"; alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");
        }
        
        // üö® playS2 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Safety Check ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô startTest)
        const playS2 = () => {
            if (qRound >= maxQ) { 
                window.s2StatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2"; 
                window.nextSection3Btn.disabled = false; 
                return; 
            }
            
            qRound++; 
            if (window.qRoundSpan) window.qRoundSpan.textContent = qRound; // üëà Safety Check
            
            const file = (globalS2Files[selectedProductType] || []).find(f => f.q_index === qRound);
            window.questionAudio = playAudio(file?.audio_url, window.s2StatusElement, window.answerBtn);
            if(qRound===1) window.startQBtn.style.display = 'none';
        }
        
        const initSection3 = () => {
            document.getElementById('section2Div').style.display='none'; document.getElementById('section3Div').style.display='block';
            window.closeBtn.disabled=false; cRound=0; window.closeBtn.style.display='block';
            lastCustomerAudioUrl = 'S3 Start'; window.s3StatusElement.textContent = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 3"; alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢");
        }
        const playS3 = () => {
            if (cRound >= maxC) { window.s3StatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3"; window.nextSection4Btn.disabled = false; window.replyBtn.disabled = true; window.closeBtn.style.display='none'; return; }
            cRound++; if (window.cRoundSpan) window.cRoundSpan.textContent = cRound;
            if(cRound===1) window.closeBtn.style.display = 'none';
            const file = (globalS3Files[selectedProductType] || []).find(f => f.ob_index === cRound);
            window.objectionAudio = playAudio(file?.audio_url, window.s3StatusElement, window.replyBtn);
        }
        
        const initSection4 = () => {
            const isHealth = selectedProductType === 'health';
            maxH = isHealth ? (globalConfig[document.querySelector('input[name="difficulty"]:checked').value]?.S4 || 5) : 1;
            if (maxH === 0) { initSection5(); return; }
            document.getElementById('section3Div').style.display='none'; document.getElementById('section4Div').style.display='block';
            currentHIndex=0; isFollowUpMode=false; followUpStep=0; updateS4UI(); 
            window.answerHBtn.disabled=false; window.answerHBtn.style.display='block'; if(window.followUpQBtn) window.followUpQBtn.style.display='none';
            alert(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 4: ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (${maxH} ‡∏Ç‡πâ‡∏≠)`);
        }
        const playS4 = () => {
            window.answerHBtn.disabled = true;
            const isHealth = selectedProductType === 'health';
            const isTrigger = isHealth ? (currentHIndex === 3) : (currentHIndex === 0);
            const dData = globalS4Questions[selectedProductType]?.selectedDisease || {};
            const url = isTrigger ? (dData.yes_trigger_url || NO_ANSWER_URL) : NO_ANSWER_URL;
            
            window.healthAudio = playAudio(url, window.hStatusElement, null);
            if (window.healthAudio) {
                window.healthAudio.onended = () => {
                    lastCustomerAudioUrl = url;
                    if (isTrigger) {
                        isFollowUpMode = true; followUpStep = 1; updateS4UI();
                        window.hStatusElement.textContent = "üé§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö '‡πÉ‡∏ä‡πà' -> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
                        window.followUpQBtn.style.display = 'inline-block'; window.answerHBtn.style.display = 'none'; window.followUpQBtn.disabled = false;
                    } else {
                        currentHIndex++;
                        if(currentHIndex < maxH) { updateS4UI(); window.hStatusElement.textContent = "‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö '‡πÑ‡∏°‡πà' -> ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"; window.answerHBtn.disabled = false; }
                        else { window.hStatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4"; window.nextSection5Btn.disabled = false; }
                    }
                };
            } else { window.answerHBtn.disabled = false; }
        }
        const playS4FollowUp = () => {
            window.followUpQBtn.disabled = true;
            const fileData = (globalS4FollowUpReplies[selectedProductType] || []).find(f => f.step_index === followUpStep);
            window.healthAudio = playAudio(fileData?.customer_audio_url, window.hStatusElement, null);
            if (window.healthAudio) {
                window.healthAudio.onended = () => {
                    lastCustomerAudioUrl = fileData?.customer_audio_url; followUpStep++;
                    if (followUpStep > maxFollowUp) {
                        isFollowUpMode = false; currentHIndex++;
                        if(currentHIndex < maxH) { updateS4UI(); window.followUpQBtn.style.display = 'none'; window.answerHBtn.style.display = 'inline-block'; window.answerHBtn.disabled = false; }
                        else { window.hStatusElement.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4"; window.followUpQBtn.style.display = 'none'; window.nextSection5Btn.disabled = false; }
                    } else { updateS4UI(); window.followUpQBtn.disabled = false; }
                };
            } else { window.followUpQBtn.disabled = false; }
        }
        
        const initSection5 = () => {
            document.getElementById('section4Div').style.display='none'; document.getElementById('section5Div').style.display='block';
            maxA = globalConfig[document.querySelector('input[name="difficulty"]:checked').value]?.S5 || 7; if(window.maxASpan) window.maxASpan.textContent=maxA;
            aRound=1; if(window.aRoundSpan) window.aRoundSpan.textContent=1; renderRegistrationSteps(); updateStepHighlight(1);
            window.answerABtn.disabled=false; window.answerABtn.textContent=`üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1`;
            alert(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô`);
        }
        const playS5 = () => {
            const step = (globalS5Steps[selectedProductType] || []).find(s => s.step_index === aRound);
            window.answerABtn.disabled = true;
            window.agreementAudio = playAudio(step?.customer_audio_url, window.aStatusElement, null);
            if (window.agreementAudio) {
                window.agreementAudio.onended = () => {
                    lastCustomerAudioUrl = step?.customer_audio_url;
                    if (aRound >= maxA) { window.aStatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!"; window.finalSaveBtn.disabled = false; updateStepHighlight(99); }
                    else { aRound++; window.aRoundSpan.textContent = aRound; updateStepHighlight(aRound); window.answerABtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${aRound}`; window.answerABtn.disabled = false; }
                };
            } else { window.answerABtn.disabled = false; }
        }

        const updateS4UI = () => {
            const d = document.getElementById('healthQuestionDisplay');
            if (isFollowUpMode) {
                const fList = globalS4FollowUpNames[selectedProductType] || [];
                const fName = fList.find(f => f.step_index === followUpStep)?.step_name || `Q${followUpStep}`;
                window.hQName.textContent = `‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep}`; d.innerHTML = `<p>‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: <strong>${fName}</strong></p>`;
                window.followUpQBtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep}`;
            } else if (currentHIndex < maxH) {
                const qText = (globalS4Questions[selectedProductType]?.qData || [])[currentHIndex] || `Q${currentHIndex+1}`;
                window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentHIndex+1}`; d.innerHTML = `<p>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å: <strong>${qText}</strong></p>`;
                window.answerHBtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠ ${currentHIndex+1}`;
            } else { d.innerHTML = "<p>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>"; }
        }
        const renderRegistrationSteps = () => {
            window.stepList.innerHTML = '';
            (globalS5Steps[selectedProductType] || []).forEach((s,i) => {
                const li = document.createElement('li'); li.id=`reg-step-${i+1}`; li.textContent=s.step_name; window.stepList.appendChild(li);
            });
        }
        const updateStepHighlight = (step) => {
            document.querySelectorAll('#stepList li').forEach(li => { li.style.fontWeight='normal'; li.style.color='#333'; });
            const li = document.getElementById(`reg-step-${step}`); if(li){ li.style.fontWeight='bold'; li.style.color='#007bff'; }
        }

        const toggleRecording = async (type) => {
            let btn, status, nextAction, part, qNum, qText, url = lastCustomerAudioUrl;
            
            if (type===1) { btn=document.getElementById("recordBtn"); status=document.getElementById("status"); nextAction=endTurn; part=1; qNum=turn+1; qText=`S1 Turn ${qNum}`; }
            else if (type===2) { btn=document.getElementById("answerBtn"); status=document.getElementById("qStatus"); nextAction=playS2; part=2; qNum=qRound; qText=`S2 Q${qNum}`; }
            else if (type===3) { btn=document.getElementById("closeBtn"); status=document.getElementById("cStatus"); nextAction=playS3; part=3; qNum=0; qText=`S3 Closing`; url="SCRIPT"; }
            else if (type===4) { btn=document.getElementById("replyBtn"); status=document.getElementById("cStatus"); nextAction=playS3; part=3; qNum=cRound; qText=`S3 Objection ${qNum}`; }
            else if (type===5) { btn=document.getElementById("answerHBtn"); status=document.getElementById("hStatus"); nextAction=playS4; part=4; qNum=currentHIndex+1; qText=`S4 Q${qNum}`; }
            else if (type===6) { btn=document.getElementById("answerABtn"); status=document.getElementById("aStatus"); nextAction=playS5; part=5; qNum=aRound; qText=`S5 Step ${qNum}`; }
            else if (type===7) { btn=window.followUpQBtn; status=document.getElementById("hStatus"); nextAction=playS4FollowUp; part=4; qNum=(currentHIndex+1)*10+followUpStep; qText=`S4 FollowUp ${followUpStep}`; }
            else if (type===8) { btn=document.getElementById("pitchRecordBtn"); status=document.getElementById("pitchStatus"); nextAction=endPitchRecording; part=15; qNum=1; qText="S1.5 Pitch"; url="SCRIPT"; }

            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    let chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        allRecordings.push({ audioBlob: blob, part, qNum, qText, customerAudioUrl: url });
                        status.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
                        btn.textContent = "üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; btn.disabled = true;
                        stream.getTracks().forEach(t => t.stop());
                        setTimeout(nextAction, 500);
                        mediaRecorder = null; 
                    };
                    
                    mediaRecorder.start();
                    btn.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
                } catch (e) { status.textContent = "‚ùå Mic Error"; }
            } else {
                if(mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                }
            }
        }

        const uploadAll = async () => {
            window.loadingOverlay.style.display = "flex";
            let success = 0;
            for (let i = 0; i < allRecordings.length; i++) {
                const rec = allRecordings[i];
                window.loadingText.textContent = `Uploading ${i+1}/${allRecordings.length}...`;
                window.uploadProgressBar.style.width = `${((i+1)/allRecordings.length)*100}%`;
                const fileName = `${currentUserId}/S${rec.part}/${uuidv4()}.webm`;
                const { error: upErr } = await window.supabase.storage.from('responses').upload(fileName, rec.audioBlob);
                if(!upErr) {
                    const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(fileName);
                    await window.supabase.from('submissions').insert([{
                        user_id: currentUserId, name: document.getElementById("inputUserName").value, 
                        part_number: rec.part, question_number: rec.qNum, question_text: rec.qText,
                        audio_url: publicUrl, insurance_type: selectedProductType, user_group: document.getElementById("inputUserGroup").value
                    }]);
                    success++;
                }
            }
            window.loadingOverlay.style.display = "none";
            if(success === allRecordings.length) { 
                document.getElementById("finalSaveBtn").textContent = "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
                document.getElementById('certificate').style.display = 'block';
                document.getElementById('traineeName').textContent = document.getElementById("inputUserName").value;
                document.getElementById('issueDate').textContent = new Date().toLocaleDateString('th-TH');
                document.getElementById("certificate").scrollIntoView();
            } else { alert("Upload incomplete"); document.getElementById("finalSaveBtn").disabled = false; }
        }

        const initializeUserAndDOM = async () => {
            // 2. DOM Element Assignments (Binding Once on Load)
            window.s1StatusElement = document.getElementById("status"); 
            window.recordBtn = document.getElementById("recordBtn");
            window.nextRoundBtn = document.getElementById("nextRoundBtn");
            window.customerAudio = document.getElementById("customerAudio");
            
            window.pitchRecordBtn = document.getElementById("pitchRecordBtn");
            window.nextSection2Btn = document.getElementById("nextSection2Btn");
            window.pitchStatusElement = document.getElementById("pitchStatus");
            
            // Section 2 Elements
            window.s2StatusElement = document.getElementById("qStatus"); 
            window.startQBtn = document.getElementById("startQBtn");
            window.answerBtn = document.getElementById("answerBtn");
            window.nextSection3Btn = document.getElementById("nextSection3Btn");
            window.questionAudio = document.getElementById("questionAudio");
            
            // Section 3
            window.s3StatusElement = document.getElementById("cStatus"); 
            window.closeBtn = document.getElementById("closeBtn");
            window.replyBtn = document.getElementById("replyBtn");
            window.objectionAudio = document.getElementById("objectionAudio");
            window.nextSection4Btn = document.getElementById("nextSection4Btn");
            
            // Section 4
            window.hQName = document.getElementById("hQName");
            window.hStatusElement = document.getElementById("hStatus");
            window.answerHBtn = document.getElementById("answerHBtn");
            window.nextSection5Btn = document.getElementById("nextSection5Btn");
            window.healthAudio = document.getElementById("healthAudio");
            
            // Section 5
            window.aStatusElement = document.getElementById("aStatus"); 
            window.answerABtn = document.getElementById("answerABtn");
            window.finalSaveBtn = document.getElementById("finalSaveBtn");
            window.agreementAudio = document.getElementById("agreementAudio");
            window.stepList = document.getElementById("stepList"); 

            // Dynamic Button for S4 (Safe Check)
            if (window.nextSection5Btn) {
                window.followUpQBtn = document.createElement('button');
                window.followUpQBtn.textContent = 'üéôÔ∏è ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; window.followUpQBtn.style.display = 'none';
                window.followUpQBtn.style.backgroundColor = '#28a745'; window.followUpQBtn.style.color = 'white';
                window.nextSection5Btn.parentNode.insertBefore(window.followUpQBtn, window.nextSection5Btn);
            }

            // 3. Bind Event Listeners
            document.getElementById("startTestBtn").onclick = startTest;
            window.recordBtn.onclick = () => toggleRecording(1);
            window.nextRoundBtn.onclick = initSection1_5;
            window.pitchRecordBtn.onclick = () => toggleRecording(8);
            window.nextSection2Btn.onclick = initSection2;
            document.getElementById("startQBtn").onclick = playS2;
            window.answerBtn.onclick = () => toggleRecording(2);
            window.nextSection3Btn.onclick = initSection3;
            window.closeBtn.onclick = () => toggleRecording(3);
            window.replyBtn.onclick = () => toggleRecording(4);
            window.nextSection4Btn.onclick = initSection4;
            window.answerHBtn.onclick = () => toggleRecording(5);
            if(window.followUpQBtn) window.followUpQBtn.onclick = () => toggleRecording(7);
            if(window.nextSection5Btn) window.nextSection5Btn.onclick = initSection5;
            window.answerABtn.onclick = () => toggleRecording(6);
            document.getElementById("finalSaveBtn").onclick = uploadAll;
            document.getElementById("certBtn").onclick = () => document.getElementById("certificate").scrollIntoView();

            await fetchInitialData();
            if(!globalS1Files['health']) { document.getElementById("startTestBtn").disabled = true; alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        }

        // üö® Final Start Test Function (Binding the Span Elements Safely)
        const startTest = function() {
            const userName = document.getElementById('inputUserName').value.trim();
            const inputProductType = document.getElementById('inputProductType').value; 
            const inputUserGroup = document.getElementById('inputUserGroup').value;     
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const config = globalConfig[selectedDifficulty];

            if (!userName || !inputUserGroup || !inputProductType) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                return;
            }
            
            selectedProductType = inputProductType;
            userGroup = inputUserGroup;

            maxTurns = config.S1;
            maxQ = config.S2;
            maxC = config.S3;
            maxH = config.S4;
            maxA = config.S5; 
            maxFollowUp = globalS4FollowUpNames[selectedProductType] ? globalS4FollowUpNames[selectedProductType].length : 5;

            // üî• CRITICAL FIX: Binding Span Elements NOW
            window.turnSpan = document.getElementById("turnSpan");
            window.maxTurnSpan = document.getElementById("maxTurnSpan");
            window.qRoundSpan = document.getElementById("qRound");
            window.maxQSpan = document.getElementById("maxQSpan");
            window.cRoundSpan = document.getElementById("cRound");
            window.maxCSpan = document.getElementById("maxCSpan");
            window.aRoundSpan = document.getElementById("aRound");
            window.maxASpan = document.getElementById("maxASpan");
            
            if (!window.qRoundSpan) {
                 console.error("CRITICAL ERROR: qRoundSpan is NULL. DOM structure is faulty.");
                 alert("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏ü‡∏•‡πå index.html ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
                 return;
            }

            window.maxTurnSpan.textContent = maxTurns;
            window.maxQSpan.textContent = maxQ;
            window.maxCSpan.textContent = maxC;
            window.maxASpan.textContent = maxA; 

            document.getElementById("registrationSection").style.display = 'none';
            document.getElementById("testSection").style.display = 'block';

            document.getElementById('section1Div').style.display = 'block';
            document.getElementById('section1_5Div').style.display = 'none';
            document.getElementById('section2Div').style.display = 'none';
            document.getElementById('section3Div').style.display = 'none';
            document.getElementById('section4Div').style.display = 'none';
            document.getElementById('section5Div').style.display = 'none';

            lastCustomerAudioUrl = 'S1 Initial Greeting (No Customer Audio)';

            if (!globalS1Files[selectedProductType] || globalS1Files[selectedProductType].length === 0) {
                 alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Product Type "${selectedProductType}" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á customer_replies_s1 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase`);
                 document.getElementById("registrationSection").style.display = 'block';
                 document.getElementById("testSection").style.display = 'none';
                 return;
            }

            prepareTurnFiles(); 
            window.recordBtn.disabled = false;
            window.turnSpan.textContent = 1;
            window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
        }


        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
    </script>
</body>
</html>
